<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KEPCO VPP Final</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #101418; --panel: #1c232e; --primary: #00d2ff; --accent: #ffc107; --danger: #ff5252; --success: #00e676; --text: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Noto Sans KR', sans-serif; color: var(--text); display: flex; flex-direction: column; height: 100vh; user-select: none; }

        /* PPT */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .slide-card { width: 90%; max-width: 800px; height: 89%; max-height: 750px; background: #fff; color: #333; border-radius: 20px; padding: 30px; display: none; flex-direction: column; box-shadow: 0 0 50px rgba(0, 210, 255, 0.5); }
        .slide-card.active { display: flex; animation: fadeIn 0.3s; }
        .slide-header { font-family: 'Jua', sans-serif; font-size: 28px; color: #0054a6; border-bottom: 3px solid #0054a6; padding-bottom: 15px; margin-bottom: 15px; flex-shrink: 0; }
        .slide-body { font-size: 16px; line-height: 1.6; flex: 1; overflow-y: auto; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .slide-text-box { width: 100%; text-align: left; background: #f0f4f8; padding: 20px; border-radius: 10px; }
        .slide-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 15px; flex-shrink: 0; }
        .btn-ppt { padding: 12px 25px; border: none; border-radius: 10px; font-size: 18px; background: #0054a6; color: white; font-family: 'Jua'; cursor: pointer; }
        .btn-start { background: var(--success); color: #000; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

        /* Header */
        header { height: 60px; background: #151a24; border-bottom: 2px solid var(--primary); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; flex-shrink: 0; }
        .logo { font-family: 'Jua'; font-size: 22px; color: #fff; } .logo span { color: var(--primary); }
        .status-bar { display: flex; gap: 15px; align-items: center; }
        .metric span { font-size: 18px; font-weight: bold; font-family: 'Consolas'; }
        
        /* Layout */
        #container { display: flex; flex: 1; height: 100%; overflow: hidden; }
        @media (max-width: 768px) { #container { flex-direction: column; } #map-area { height: 55%; order: 1; } #panel { width: 100%; height: 45%; order: 2; border-left: none; border-top: 1px solid #333; } }
        
        #panel { width: 360px; background: var(--panel); border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 10; overflow-y: auto; }
        .card { background: #252d3d; padding: 12px; border-radius: 10px; border: 1px solid #333; }
        .card-title { font-size: 14px; font-weight: bold; color: var(--primary); margin-bottom: 8px; border-bottom: 1px solid #444; padding-bottom: 4px; }

        #ai-box { background: #fff; color: #000; padding: 10px; border-radius: 10px; border-left: 5px solid var(--primary); display: flex; align-items: center; gap: 10px; min-height: 50px; transition: 0.3s; }
        .ai-face { font-size: 30px; } .ai-msg { font-weight: bold; font-size: 13px; line-height: 1.3; }
        
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 12px; }
        .res-item span:last-child { float: right; color: var(--success); font-weight: bold; }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        .ctrl-btn { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: #fff; opacity: 0.4; font-family: 'Jua'; font-size: 14px; pointer-events: none; }
        .ctrl-btn.unlocked { opacity: 1; pointer-events: auto; box-shadow: 0 0 5px rgba(255,255,255,0.2); }
        .ctrl-btn.active { opacity: 1; transform: scale(1.05); box-shadow: 0 0 10px currentColor; border: 2px solid #fff; }
        .c-charge { background: var(--danger); } .c-discharge { background: var(--success); }
        .c-DR(ìˆ˜ìš”ê°ì¶•) { background: #9c27b0; grid-column: span 2; } .c-cut { background: #ff9800; grid-column: span 2; }

        .ai-switch { background: #333; color: #aaa; padding: 8px; border-radius: 8px; text-align: center; cursor: pointer; font-weight: bold; border: 1px solid #555; margin-bottom: 5px; font-size: 13px; pointer-events: none; opacity: 0.5; }
        .ai-switch.on { background: var(--success); color: #000; border-color: #fff; }

        #map-area { flex: 1; position: relative; background: radial-gradient(circle at 50% 50%, #1b263b 0%, #0b0c15 100%); overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }

        #guide-overlay { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.95); border: 2px solid var(--accent); color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 16px; font-weight: bold; pointer-events: none; display: none; z-index: 50; white-space: nowrap; }
        #forecast-banner { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); background: rgba(255, 193, 7, 0.9); color: #000; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 14px; display: none; animation: slideDown 0.5s; z-index: 40; }
        @keyframes slideDown { from{top:-50px} to{top:70px} }
    </style>
</head>
<body>

    <div id="intro-overlay">
        
        <!-- Slide 1: VPP ê°œìš” -->
        <div class="slide-card active" id="slide-1">
            <div class="slide-header">1. ê°€ìƒë°œì „ì†Œ(VPP) ê°œìš”</div>
            <div class="slide-body">
                <div style="font-size:50px; text-align:center; margin-bottom:20px;">ğŸ”Œ â˜€ï¸ ğŸ”‹</div>
                <div class="slide-icon">ğŸ”Œ + â˜€ï¸ + ğŸ’» = ğŸ­</div>
                <div class="slide-text-box">
                    <b>[ì •ì˜]</b> ICT ê¸°ìˆ ë¡œ ë¶„ì‚°ëœ ì—ë„ˆì§€ë¥¼ ì—°ê²°í•˜ì—¬ <b>í•˜ë‚˜ì˜ ë°œì „ì†Œì²˜ëŸ¼ ì œì–´</b>í•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.<br><br>
                    <b>[ëª©ì ]</b> ì¬ìƒì—ë„ˆì§€ì˜ ë¶ˆì•ˆì •í•¨ì„ <b>ESS</b>ì™€ <b>ì œì–´ ê¸°ìˆ </b>ë¡œ ë³´ì™„í•©ë‹ˆë‹¤. <br><br>
                    <b>[í•µì‹¬ ê°€ì¹˜]</b><br>
                    ë¶ˆê·œì¹™í•œ ì¬ìƒì—ë„ˆì§€ì˜ ë³€ë™ì„±ì„ <b>ì œì–´ ê°€ëŠ¥í•œ ìì›(ESS)</b>ìœ¼ë¡œ ë³´ì™„í•˜ì—¬, ì•ˆì •ì ì¸ ì „ë ¥ ê³µê¸‰ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.
                </div>
            </div>
            <div class="slide-footer">
                <div class="credits">MADE BY SONG</div>
                         <div class="slide-footer">
                            <button class="btn-ppt" onclick="nextSlide(2)">ë‹¤ìŒ â–¶</button>
            </div>
            </div>
        </div>

        <!-- Slide 2: í•œì „ì˜ ì—­í•  -->
        <div class="slide-card" id="slide-2">
            <div class="slide-header">2. í•œì „(KEPCO)ì˜ ì—­í• </div>
            <div class="slide-body">
                <div class="slide-icon">âš–ï¸ 60.00Hz</div>
                <div class="slide-text-box">
                    ì „ë ¥ë§ì€ <b>ìƒì‚°ê³¼ ì†Œë¹„ì˜ ê· í˜•(60Hz)</b>ì´ ìƒëª…ì…ë‹ˆë‹¤.<br><br>
                    <b>[ìš´ì˜ ë§¤ë‰´ì–¼]</b><br>
                    - ë°œì „ëŸ‰ ë¶€ì¡± ì‹œ : <b style="color:red">ì •ì „ ìœ„í—˜!</b> â” [ESS ë°©ì „] / [DR(ìˆ˜ìš”ê°ì¶•)]<br>
                    - ë°œì „ëŸ‰ ê³¼ì‰ ì‹œ : <b style="color:orange">ê³¼ë¶€í•˜ ìœ„í—˜!</b> â” [ESS ì¶©ì „] / [ì‹ ì¬ìƒ ì¶œë ¥ì œì–´]
                    ì „ë ¥ë§ì€ <b>ìƒì‚°(ê³µê¸‰)ê³¼ ì†Œë¹„(ìˆ˜ìš”)ì˜ ê· í˜•</b>ì´ í•µì‹¬ì…ë‹ˆë‹¤.<br>
                    ì´ ê· í˜•ì´ ê¹¨ì§€ë©´ <b>ì£¼íŒŒìˆ˜(60Hz)</b>ê°€ í”ë“¤ë ¤ ì •ì „ì´ ë°œìƒí•©ë‹ˆë‹¤.<br><br>
                    <b>[ìš´ì˜ìì˜ í•µì‹¬ ì„ë¬´]</b><br>
                    ğŸ”´ <b>ì „ë ¥ ë¶€ì¡± ì‹œ:</b> ì£¼íŒŒìˆ˜ í•˜ë½ â” <b>[ESS ë°©ì „] / [DR(ìˆ˜ìš”ê°ì¶•)(ìˆ˜ìš”ê°ì¶•)]</b><br>
                    ğŸ”µ <b>ì „ë ¥ ê³¼ì‰ ì‹œ:</b> ì£¼íŒŒìˆ˜ ìƒìŠ¹ â” <b>[ESS ì¶©ì „] / [ì‹ ì¬ìƒ ì¶œë ¥ì œì–´]</b>
                </div>
            </div>
            <div class="slide-footer">
                <button class="btn-ppt" onclick="nextSlide(1)">â—€ ì´ì „</button>
                <button class="btn-ppt" onclick="nextSlide(3)">ë‹¤ìŒ â–¶</button>
            </div>
        </div>

        <!-- Slide 3: ì œì‘ ì˜ë„ (ì‹ ê·œ) -->
        <div class="slide-card" id="slide-3">
            <div class="slide-header">3. ì‹œë®¬ë ˆì´í„° ì œì‘ ì˜ë„</div>
            <div class="slide-body">
                <div class="slide-icon">ğŸ“ ğŸš€</div>
                <div class="slide-text-box">
                    <b>[ì§ê´€ì  í•™ìŠµ]</b><br>
                    ë³µì¡í•œ ì „ë ¥ ê³„í†µ ìš´ì˜ ì›ë¦¬ë¥¼ <b>ì‹œë®¬ë ˆì´ì…˜ ê²Œì„</b> í˜•íƒœë¡œ êµ¬í˜„í•˜ì—¬,<br>
                    ëˆ„êµ¬ë‚˜ ì‰½ê³  ì¬ë¯¸ìˆê²Œ <b>VPPì˜ ê°œë…ê³¼ í•„ìš”ì„±</b>ì„ ì´í•´í•˜ë„ë¡ ë•ìŠµë‹ˆë‹¤.<br><br>
                    <b>[ë¯¸ë˜ì˜ ICTì‹œìŠ¤í…œ ì¤€ë¹„]</b><br>
                    ì—ë„ˆì§€ ëŒ€ì „í™˜ ì‹œëŒ€ì— ë§ì¶°, <b>ë””ì§€í„¸ ê¸°ë°˜ì˜ ì „ë ¥ë§ ìš´ì˜ ê²½í—˜</b>ì„ ì„ ì œì ìœ¼ë¡œ ì œê³µí•©ë‹ˆë‹¤.
                </div>
            </div>
            <div class="slide-footer">
                <div class="credits"></div>
                <div>
                    <button class="btn-ppt" onclick="nextSlide(2)">â—€ ì´ì „</button>
                    <button class="btn-ppt" onclick="nextSlide(4)">ë‹¤ìŒ â–¶</button>
                </div>
            </div>
        </div>

        <!-- Slide 4: ê²Œì„ ë°©ë²• -->
        <div class="slide-card" id="slide-4">
            <div class="slide-header">4. ê²Œì„ í”Œë ˆì´ ë°©ë²•</div>
            <div class="slide-body">
                <div class="slide-icon">ğŸ®</div>
                <div class="slide-text-box">
                    1. <b>ìë™ ì„±ì¥:</b> íƒœì–‘ê´‘,í’ë ¥,ê³µì¥,ì•„íŒŒíŠ¸ ë“± ì„¤ë¹„ëŠ” êµ­ê°€ ê³„íšì— ë”°ë¼ <b>ìë™ ê±´ì„¤</b>ë©ë‹ˆë‹¤.<br>
                    2. <b>AI íŒ:</b> ì‹¤ì „ì—ì„œ AIê°€ íŒì„ ì¤ë‹ˆë‹¤.<br>
                    3. <b>íŠœí† ë¦¬ì–¼:</b> ë¨¼ì € ìœ„ê¸° ëŒ€ì‘ë²•ì„ ì‹¤ìŠµí•©ë‹ˆë‹¤.<br><br>
                </div>
                <div class="slide-text-box">
                    <b>[ìƒí™©ë³„ ëŒ€ì‘ ë§¤ë‰´ì–¼]</b><br>
                    ì£¼íŒŒìˆ˜(60Hz) ìœ ì§€ë¥¼ ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ ì¡°ì¹˜í•˜ì„¸ìš”.<br><br>
                    
                    <span style="color:#ff5252;">ğŸ”´ <b>ë°œì „ < ìˆ˜ìš” (ì „ë ¥ ë¶€ì¡±)</b></span><br>
                    "ì „ê¸°ê°€ ëª¨ìë¼ìš”! ê³µê¸‰ì„ ëŠ˜ë¦¬ê±°ë‚˜ ìˆ˜ìš”ë¥¼ ì¤„ì´ì„¸ìš”."<br>
                    ğŸ‘‰ <b>ì¡°ì¹˜: [ESS ë°©ì „]</b> ë˜ëŠ” <b>[DR(ìˆ˜ìš”ê°ì¶•)(ìˆ˜ìš”ê°ì¶•)]</b><br><br>

                    <span style="color:#00d2ff;">ğŸ”µ <b>ë°œì „ > ìˆ˜ìš” (ì „ë ¥ ê³¼ì‰)</b></span><br>
                    "ì „ê¸°ê°€ ë„˜ì³ìš”! ë‚¨ëŠ” ì „ê¸°ë¥¼ ë‹´ê±°ë‚˜ ë°œì „ì„ ë„ì„¸ìš”."<br>
                    ğŸ‘‰ <b>ì¡°ì¹˜: [ESS ì¶©ì „]</b> ë˜ëŠ” <b>[ì‹ ì¬ìƒ ì¶œë ¥ì œì–´]</b>
                </div>
            </div>
            <div class="slide-footer">
                <button class="btn-ppt" onclick="nextSlide(3)">â—€ ì´ì „</button>
                <button class="btn-ppt btn-start" onclick="startGame()">íŠœí† ë¦¬ì–¼ ì‹œì‘ ğŸš€</button>
            </div>
        </div>

    </div>

    <header>
        <div class="logo">âš¡ KEPCO <span style="color:var(--primary)">VPP</span></div>
        <div class="status-bar">
            <div class="metric"><label>LEVEL</label><span id="ui-level">1</span></div>
            <div class="metric"><label>FREQ</label><span id="ui-freq" style="color:var(--primary)">60.00</span> Hz</div>
        </div>
    </header>

    <div id="container">
        <div id="panel">
            <div id="ai-box"><div class="ai-face">ğŸ¤–</div><div class="ai-msg" id="ai-text">ì‹œìŠ¤í…œ ëŒ€ê¸° ì¤‘...</div></div>
            <div class="ai-switch" id="btn-auto" onclick="toggleAuto()">â— AI ìë™ ìš´ì „ (OFF)</div>
            
            <div class="card">
                <div class="card-title">ğŸ“Š ì‹¤ì‹œê°„ ìˆ˜ê¸‰</div>
                <div class="res-grid">
                    <span>âš¡ ê³µê¸‰ <span id="val-sup" style="font-weight:bold; color:var(--success);">0</span></span>
                    <span>ğŸ¢ ìˆ˜ìš” <span id="val-dem" style="font-weight:bold; color:var(--danger);">0</span></span>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ›ï¸ VPP ì œì–´</div>
                <div class="btn-grid">
                    <button class="ctrl-btn c-charge" id="btn-c" onclick="manual('charge')">ESS ì¶©ì „</button>
                    <button class="ctrl-btn c-discharge" id="btn-d" onclick="manual('discharge')">ESS ë°©ì „</button>
                    <button class="ctrl-btn c-DR(ìˆ˜ìš”ê°ì¶•)" id="btn-DR(ìˆ˜ìš”ê°ì¶•)" onclick="toggleDR(ìˆ˜ìš”ê°ì¶•)()">ğŸ­ DR(ìˆ˜ìš”ê°ì¶•) ë°œë ¹</button>
                    <button class="ctrl-btn c-cut" id="btn-cut" onclick="toggleCut()">âœ‚ï¸ ì‹ ì¬ìƒ ì¶œë ¥ì œì–´</button>
                </div>
                <div style="margin-top:10px; font-size:12px; color:#aaa;">ESS ì”ëŸ‰: <span id="val-soc">50%</span></div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ—ï¸ ì„¤ë¹„ í˜„í™© (ìë™ì¦ì„¤)</div>
                <div class="res-grid">
                    <div>â˜€ï¸ íƒœì–‘ê´‘ <span id="cnt-solar" style="color:var(--success)">0</span></div>
                    <div>ğŸŒ€ í’ë ¥ <span id="cnt-wind" style="color:var(--success)">0</span></div>
                    <div>ğŸ¢ ì•„íŒŒíŠ¸ <span id="cnt-apt" style="color:var(--danger)">0</span></div>
                    <div>ğŸ­ ê³µì¥ <span id="cnt-fac" style="color:var(--danger)">0</span></div>
                </div>
            </div>
        </div>

        <div id="map-area">
            <canvas id="gameCanvas"></canvas>
            <div id="guide-overlay"></div>
            <div id="forecast-banner"></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const TICK_SPEED = 0.3; const MAX_LEVEL = 20;

        let isRunning = false, isAuto = false, mode = 'PPT', step = 0;
        let time = 720, level = 1, freq = 60.00;
        let supply = 0, demand = 0, targetSupply = 0, targetDemand = 0;
        let essCap = 2000, essLevel = 1000, action = 'stop', DR(ìˆ˜ìš”ê°ì¶•)On = false, cutOn = false;
        let pendingExpansion = null;

        const nodes = [
            {id:'seoul', name:'ìˆ˜ë„ê¶Œ', x:0.35, y:0.25, c:'#ef5350'}, {id:'gangwon', name:'ê°•ì›', x:0.7, y:0.2, c:'#42a5f5'},
            {id:'chungcheong', name:'ì¶©ì²­', x:0.4, y:0.45, c:'#ffa726'}, {id:'honam', name:'í˜¸ë‚¨', x:0.3, y:0.7, c:'#ab47bc'},
            {id:'yeongnam', name:'ì˜ë‚¨', x:0.75, y:0.65, c:'#26c6da'}, {id:'jeju', name:'ì œì£¼', x:0.3, y:0.92, c:'#66bb6a'}
        ];
        let objects = [];

        function resize() { if(canvas){ canvas.width = document.getElementById('map-area').clientWidth; canvas.height = document.getElementById('map-area').clientHeight; } }
        window.addEventListener('resize', resize);

        function nextSlide(n) { document.querySelectorAll('.slide-card').forEach(s => s.classList.remove('active')); document.getElementById('s'+n).classList.add('active'); }

        function startGame() {
            document.getElementById('intro-overlay').style.display = 'none';
            resize(); isRunning = true;
            spawn('solar','honam',2); spawn('wind','jeju',1); spawn('apt','seoul',3);
            startTutorial(); gameLoop();
        }

        function spawn(type, rid, count=1) {
            let n = nodes.find(x=>x.id===rid); if(!n)return;
            for(let i=0; i<count; i++) objects.push({type:type, x:n.x+(Math.random()-.5)*0.15, y:n.y+(Math.random()-.5)*0.15, phase:Math.random()*10});
        }

        function startTutorial() {
            mode = 'TUTORIAL';
            document.getElementById('btn-auto').style.pointerEvents = 'none'; document.getElementById('btn-auto').style.opacity = '0.5';
            setTutorialStep(1);
        }

        function setTutorialStep(s) {
            step = s;
            const guide = document.getElementById('guide-overlay'); guide.style.display = 'block';
            document.querySelectorAll('.ctrl-btn').forEach(b => { b.classList.remove('unlocked','active'); b.style.opacity='0.2'; b.style.pointerEvents='none'; });

            if(s===1) {
                guide.innerHTML = "ğŸš¨ ì „ë ¥ ë¶€ì¡±! <b>[ESS ë°©ì „]</b> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”!";
                let btn = document.getElementById('btn-d'); btn.classList.add('unlocked'); btn.style.opacity='1'; btn.style.pointerEvents='auto';
                setAIText("ì „ë ¥ ë¶€ì¡± ë°œìƒ! ë°©ì „ì´ í•„ìš”í•©ë‹ˆë‹¤.", "alert"); targetDemand=4000; targetSupply=2000;
            } else if(s===2) {
                guide.innerHTML = "ğŸš¨ ì „ë ¥ ê³¼ì‰! <b>[ì‹ ì¬ìƒ ì¶œë ¥ì œì–´]</b>ë¥¼ ëˆ„ë¥´ì„¸ìš”!";
                let btn = document.getElementById('btn-cut'); btn.classList.add('unlocked'); btn.style.opacity='1'; btn.style.pointerEvents='auto';
                setAIText("ë°œì „ëŸ‰ ê³¼ë‹¤! ì‹ ì¬ìƒ ì¶œë ¥ì œì–´ í•˜ì„¸ìš”.", "alert"); targetDemand=2000; targetSupply=4000; action='stop'; updateBtns();
            } else if(s===3) {
                guide.innerHTML = "ğŸ‰ íŠœí† ë¦¬ì–¼ ì™„ë£Œ! ì‹¤ì „ ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.";
                setTimeout(initRealMode, 2000);
            }
        }

        function initRealMode() {
            mode = 'REAL';
            document.getElementById('guide-overlay').style.display = 'none';
            document.querySelectorAll('.ctrl-btn').forEach(b => { b.classList.add('unlocked'); b.style.opacity='1'; b.style.pointerEvents='auto'; });
            document.getElementById('btn-auto').style.pointerEvents='auto'; document.getElementById('btn-auto').style.opacity='1';
            
            action='stop'; DR(ìˆ˜ìš”ê°ì¶•)On=false; cutOn=false; updateBtns();
            level = 1; time = 720;
            
            // â˜… ì¤‘ìš”: ì‹¤ì „ ëª¨ë“œ ì„¤ë¹„ ëŒ€ê±° ì¶”ê°€ (ìˆ˜ì¹˜ 0 ë°©ì§€) â˜…
            objects = [];
            spawn('solar','honam',5); spawn('wind','jeju',3); spawn('wind','gangwon',2); spawn('apt','seoul',5); spawn('factory','yeongnam',2);
            
            setAIText("ì‹¤ì „ ëª¨ë“œ ì‹œì‘. ì£¼íŒŒìˆ˜ë¥¼ 60Hzë¡œ ìœ ì§€í•˜ì„¸ìš”.", "neutral");
        }

        function manual(act) {
            if(isAuto) return;
            if(mode === 'TUTORIAL') {
                if(step===1 && act==='discharge') { action='discharge'; updateBtns(); setAIText("ì„±ê³µ! ê³µê¸‰ì´ ëŠ˜ì–´ë‚©ë‹ˆë‹¤.", "happy"); setTimeout(()=>setTutorialStep(2),800); }
                return;
            }
            action = (action===act) ? 'stop' : act; updateBtns();
        }

        function toggleDR(ìˆ˜ìš”ê°ì¶•)() { if(!isAuto && mode==='REAL') { DR(ìˆ˜ìš”ê°ì¶•)On=!DR(ìˆ˜ìš”ê°ì¶•)On; updateBtns(); } }
        
        function toggleCut() { 
            if(isAuto) return;
            if(mode==='TUTORIAL') {
                if(step===2) { cutOn=!cutOn; updateBtns(); if(cutOn){ setAIText("ì„±ê³µ! ë°œì „ì„ ì œí•œí•©ë‹ˆë‹¤.", "happy"); setTimeout(()=>setTutorialStep(3),800); } }
                return;
            }
            cutOn = !cutOn; updateBtns();
        }

        function toggleAuto() {
            isAuto = !isAuto;
            document.getElementById('btn-auto').classList.toggle('on', isAuto);
            if(!isAuto) { action='stop'; DR(ìˆ˜ìš”ê°ì¶•)On=false; cutOn=false; updateBtns(); }
        }

        function updateBtns() {
            document.querySelectorAll('.ctrl-btn').forEach(b=>b.classList.remove('active'));
            if(action==='charge') document.getElementById('btn-c').classList.add('active');
            if(action==='discharge') document.getElementById('btn-d').classList.add('active');
            if(DR(ìˆ˜ìš”ê°ì¶•)On) document.getElementById('btn-DR(ìˆ˜ìš”ê°ì¶•)').classList.add('active');
            if(cutOn) document.getElementById('btn-cut').classList.add('active');
        }

        function gameLoop() { if(isRunning) { updatePhysics(); if(mode==='REAL') aiLogic(); DR(ìˆ˜ìš”ê°ì¶•)aw(); updateUI(); requestAnimationFrame(gameLoop); } }

        function updatePhysics() {
            time += TICK_SPEED;
            if(time >= 1440) { time=0; if(mode==='REAL') handleLevelUp(); }

            if(pendingExpansion) {
                pendingExpansion.timer--;
                if(pendingExpansion.timer <= 0) {
                    spawn(pendingExpansion.type, pendingExpansion.region, pendingExpansion.count);
                    document.getElementById('forecast-banner').style.display='none';
                    pendingExpansion = null;
                }
            }

            if(mode === 'REAL') {
                let h = time/60;
                let curve = (h>9 && h<21) ? 1.3 : 0.7;
                let baseLoad = 2000; // ê¸°ë³¸ ë¶€í•˜
                objects.forEach(o=>{ if(o.type==='apt') baseLoad+=100; if(o.type==='factory') baseLoad+=300; });
                
                let tDem = baseLoad * curve;
                if(DR(ìˆ˜ìš”ê°ì¶•)On) tDem *= 0.8;

                let baseGen = 2000 + (level*100);
                let reGen = 0;
                let sun = (h>7&&h<18)?Math.sin((h-7)/11*Math.PI):0;
                let wind = 0.5 + Math.sin(time*0.05)*0.3;
                objects.forEach(o=>{ if(o.type==='solar') reGen+=300*sun; if(o.type==='wind') reGen+=400*wind; });
                
                let tSup = baseGen + reGen;
                if(cutOn) tSup *= 0.7;

                essCap = 2000 + (objects.length*100);
                let flow = 0;
                if(isAuto) autoControl(tSup, tDem);

                if(action==='charge') flow = -1500;
                if(action==='discharge') flow = 1500;
                
                essLevel -= flow * 0.03;
                essLevel = Math.max(0, Math.min(essLevel, essCap));
                tSup += flow;

                targetDemand = tDem; targetSupply = tSup;
            }

            demand += (targetDemand - demand) * 0.1;
            supply += (targetSupply - supply) * 0.1;

            let diff = supply - demand;
            freq += diff * 0.00005;
            freq += (60 - freq) * 0.03;
        }

        function handleLevelUp() {
            if(level<20) {
                level++;
                let t = ['solar','wind','apt','factory'][Math.floor(Math.random()*4)];
                let r = ['honam','gangwon','seoul','yeongnam'][Math.floor(Math.random()*4)];
                document.getElementById('forecast-banner').innerText = `ğŸ“¢ [ì˜ˆë³´] ì ì‹œ í›„ ${r}ì§€ì—­ ${t} ì¦ì„¤!`;
                document.getElementById('forecast-banner').style.display = 'block';
                pendingExpansion = { type:t, region:r, count:2, timer:300 };
            }
        }

        function autoControl(g, l) {
            if(g > l + 200) { if(essLevel<essCap){action='charge'; cutOn=false;} else{action='stop'; cutOn=true;} }
            else if(g < l - 200) { if(essLevel>0){action='discharge'; DR(ìˆ˜ìš”ê°ì¶•)On=false;} else{action='stop'; DR(ìˆ˜ìš”ê°ì¶•)On=true;} }
            else { action='stop'; cutOn=false; DR(ìˆ˜ìš”ê°ì¶•)On=false; }
            updateBtns();
        }

        function aiLogic() {
            if(isAuto) { setAIText("AI ìë™ ì œì–´ ì¤‘ì…ë‹ˆë‹¤.", "happy"); return; }
            if(supply > demand + 200) setAIText("ê³¼ì‰ ê³µê¸‰! [ESSì¶©ì „] ë˜ëŠ” [ì‹ ì¬ìƒ ì¶œë ¥ì œì–´]!", "worry");
            else if(supply < demand - 200) setAIText("ì „ë ¥ ë¶€ì¡±! [ESSë°©ì „] ë˜ëŠ” [DR(ìˆ˜ìš”ê°ì¶•)]!", "alert");
            else setAIText("ì•ˆì •ì ì…ë‹ˆë‹¤.", "neutral");
        }

        function setAIText(msg, mood) {
            const box = document.getElementById('ai-box');
            const txt = document.getElementById('ai-text');
            const face = document.querySelector('.ai-face');
            txt.innerText = msg;
            if(mood==='alert') { box.style.borderColor='var(--danger)'; face.innerText='ğŸš¨'; }
            else if(mood==='worry') { box.style.borderColor='var(--accent)'; face.innerText='ğŸ˜®'; }
            else if(mood==='happy') { box.style.borderColor='var(--success)'; face.innerText='ğŸ¤–'; }
            else { box.style.borderColor='#444'; face.innerText='ğŸ¤–'; }
        }

        function DR(ìˆ˜ìš”ê°ì¶•)aw() {
            let w=canvas.width; let h=canvas.height;
            ctx.clearRect(0,0,w,h);
            ctx.strokeStyle='rgba(255,255,255,0.1)'; ctx.lineWidth=2; ctx.beginPath();
            let c = getNodePos('chungcheong');
            nodes.forEach(n=>{ if(n.id!=='chungcheong'&&n.id!=='jeju') { let p=getNodePos(n.id); ctx.moveTo(c.x, c.y); ctx.lineTo(p.x, p.y); }});
            let p1=getNodePos('honam'), p2=getNodePos('jeju'); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y);
            ctx.stroke();
            nodes.forEach(n=>{
                let p=getNodePos(n.id);
                ctx.beginPath(); ctx.arc(p.x, p.y, 50, 0, Math.PI*2);
                ctx.fillStyle=n.c; ctx.globalAlpha=0.2; ctx.fill();
                ctx.strokeStyle=n.c; ctx.globalAlpha=1; ctx.lineWidth=2; ctx.stroke();
                ctx.fillStyle='#fff'; ctx.font='bold 16px Noto Sans KR'; ctx.textAlign='center';
                ctx.fillText(n.name, p.x, p.y-10);
            });
            objects.forEach(o=>{
                let px=o.x*w; let py=o.y*h;
                let icon = o.type==='solar'?'â˜€ï¸':(o.type==='wind'?'ğŸŒ€':(o.type==='apt'?'ğŸ¢':'ğŸ­'));
                let float = Math.sin(Date.now()*0.003 + o.phase)*3;
                ctx.font='24px Arial'; ctx.fillText(icon, px, py+float);
            });
        }

        function getNodePos(id) {
            let w=canvas.width; let h=canvas.height;
            let n=nodes.find(x=>x.id===id);
            return {x:n.x*w, y:n.y*h};
        }

        function updateUI() {
            let hh=Math.floor(time/60).toString().padStart(2,'0');
            let mm=Math.floor(time%60).toString().padStart(2,'0');
            document.getElementById('ui-level').innerText = level;
            document.getElementById('ui-freq').innerText = freq.toFixed(2);
            document.getElementById('ui-freq').style.color = (freq<59.8||freq>60.2)?'var(--danger)':'var(--primary)';
            document.getElementById('val-sup').innerText = Math.floor(supply);
            document.getElementById('val-dem').innerText = Math.floor(demand);
            document.getElementById('val-soc').innerText = Math.floor(essLevel/essCap*100)+"%";
            document.getElementById('cnt-solar').innerText = objects.filter(o=>o.type==='solar').length;
            document.getElementById('cnt-wind').innerText = objects.filter(o=>o.type==='wind').length;
            document.getElementById('cnt-apt').innerText = objects.filter(o=>o.type==='apt').length;
            document.getElementById('cnt-fac').innerText = objects.filter(o=>o.type==='factory').length;
        }
    </script>
</body>
</html>
