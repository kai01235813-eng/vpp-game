<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KEPCO VPP Master Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* === UI í…Œë§ˆ === */
        :root {
            --bg: #101418;
            --panel: #1c232e;
            --primary: #00d2ff;
            --accent: #ffc107;
            --danger: #ff5252;
            --success: #00e676;
            --text: #ffffff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; overflow: hidden; background: var(--bg);
            font-family: 'Noto Sans KR', sans-serif; color: var(--text);
            display: flex; flex-direction: column; height: 100vh; user-select: none;
        }

        /* === ëª¨ë°”ì¼ ëŒ€ì‘ ìŠ¤íƒ€ì¼ === */
        @media (max-width: 768px) {
            #container { flex-direction: column !important; }
            #map-area { height: 50% !important; width: 100% !important; }
            #panel { width: 100% !important; height: 50% !important; border-left: none !important; border-top: 1px solid #333; overflow-y: auto; }
            .slide-card { width: 90% !important; height: 80% !important; padding: 20px !important; }
            .slide-icon { font-size: 50px !important; margin: 10px 0 !important; }
            .slide-body { font-size: 15px !important; }
            .btn-grid { grid-template-columns: 1fr 1fr 1fr 1fr !important; } /* ë²„íŠ¼ í•œì¤„ë¡œ */
            .ctrl-btn { padding: 10px !important; font-size: 12px !important; }
            header { padding: 0 15px !important; }
            .res-grid { grid-template-columns: 1fr 1fr !important; } /* ì„¤ë¹„í˜„í™© 2ì—´ */
        }

        /* === 1. ì¸íŠ¸ë¡œ PPT === */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .slide-card {
            width: 800px; height: 500px; background: #fff; color: #333;
            border-radius: 20px; padding: 40px; display: none; flex-direction: column;
            box-shadow: 0 0 50px rgba(0, 210, 255, 0.5);
        }
        .slide-card.active { display: flex; animation: fadeIn 0.3s; }
        
        .slide-header { 
            font-family: 'Jua', sans-serif; font-size: 28px; color: #0054a6; 
            border-bottom: 3px solid #0054a6; padding-bottom: 10px; margin-bottom: 15px;
        }
        .slide-body { font-size: 18px; line-height: 1.6; flex: 1; overflow-y: auto; }
        .slide-icon { text-align: center; font-size: 70px; margin: 20px 0; }
        .slide-box { background: #f0f4f8; padding: 15px; border-radius: 10px; margin-top: 10px; }
        .slide-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        
        .btn-ppt {
            padding: 10px 25px; border: none; border-radius: 8px; font-size: 16px; 
            background: #0054a6; color: white; font-family: 'Jua'; cursor: pointer;
        }
        .btn-start { background: var(--success); color: #000; }

        @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }

        /* === 2. í—¤ë” === */
        header {
            height: 60px; background: #151a24; border-bottom: 2px solid var(--primary);
            display: flex; align-items: center; justify-content: space-between; padding: 0 30px;
            flex-shrink: 0; z-index: 100;
        }
        .logo { font-family: 'Jua'; font-size: 24px; color: #fff; }
        .logo span { color: var(--primary); }
        .status-bar { display: flex; gap: 20px; align-items: center; }
        .coin-box {
            display: flex; align-items: center; gap: 5px; background: rgba(255, 215, 0, 0.15);
            padding: 5px 15px; border-radius: 20px; border: 1px solid gold;
        }
        .coin-svg { width: 20px; height: 20px; fill: gold; }
        .metric label { font-size: 10px; color: #aaa; display: block; }
        .metric span { font-size: 18px; font-weight: bold; font-family: 'Consolas'; }

        /* === 3. ë ˆì´ì•„ì›ƒ === */
        #container { display: flex; flex: 1; overflow: hidden; }

        #map-area {
            flex: 1; position: relative; background: radial-gradient(circle at 50% 50%, #1b263b 0%, #0b0c15 100%);
            overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100%; }

        #panel {
            width: 360px; background: var(--panel); border-left: 1px solid #333;
            padding: 15px; display: flex; flex-direction: column; gap: 15px;
            z-index: 10; overflow-y: auto;
        }

        .card { background: #252d3d; padding: 12px; border-radius: 10px; border: 1px solid #333; }
        .card-title { font-size: 14px; font-weight: bold; color: var(--primary); margin-bottom: 8px; border-bottom: 1px solid #444; padding-bottom: 4px; }

        /* AI ë©”ì‹œì§€ */
        #ai-box {
            background: #fff; color: #000; padding: 10px; border-radius: 10px;
            border: 3px solid var(--primary); display: flex; align-items: center; gap: 10px;
            min-height: 50px; transition: 0.3s;
        }
        .ai-icon { font-size: 24px; }
        .ai-msg { font-weight: bold; font-size: 13px; line-height: 1.3; }

        /* ì„¤ë¹„ í˜„í™© */
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 12px; }
        .res-item span:last-child { float: right; color: var(--success); font-weight: bold; }

        /* ë²„íŠ¼ */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        .ctrl-btn {
            padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;
            color: #fff; opacity: 0.4; transition: 0.2s; font-family: 'Jua'; font-size: 13px;
        }
        .ctrl-btn.active { opacity: 1; transform: scale(1.05); box-shadow: 0 0 10px currentColor; }
        
        .c-charge { background: var(--danger); }
        .c-discharge { background: var(--success); }
        .c-dr { background: #9c27b0; grid-column: span 2; }
        .c-cut { background: #ff9800; grid-column: span 2; }

        /* AI ìŠ¤ìœ„ì¹˜ */
        .ai-switch {
            background: #333; color: #aaa; padding: 8px; border-radius: 8px; text-align: center;
            cursor: pointer; font-weight: bold; border: 1px solid #555; font-size: 14px;
        }
        .ai-switch.on { background: var(--success); color: #000; border-color: #fff; }

        /* íŠœí† ë¦¬ì–¼ ê°€ì´ë“œ */
        #guide-overlay {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); border: 2px solid var(--success); color: #fff;
            padding: 10px 20px; border-radius: 30px; font-size: 16px; font-weight: bold;
            pointer-events: none; display: none; z-index: 50; white-space: nowrap;
        }

        /* ì˜ˆë³´ ë°°ë„ˆ */
        #forecast-banner {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 193, 7, 0.9); color: #000; padding: 8px 20px; 
            border-radius: 20px; font-weight: bold; font-size: 14px;
            display: none; animation: slideDown 0.5s; z-index: 40;
        }
        @keyframes slideDown { from{top:-50px} to{top:60px} }

    </style>
</head>
<body>

    <div id="intro-overlay">
        <div class="slide-card active" id="s1">
            <div class="slide-header">1. ê°€ìƒë°œì „ì†Œ(VPP)ë€?</div>
            <div class="slide-body">
                <div class="slide-icon">ğŸ”Œâ•â˜€ï¸ğŸŸ°ğŸ­</div>
                <div class="slide-box">
                    í©ì–´ì ¸ ìˆëŠ” íƒœì–‘ê´‘, í’ë ¥, ESSë¥¼ ICT ê¸°ìˆ ë¡œ ì—°ê²°í•˜ì—¬<br>
                    <b>í•˜ë‚˜ì˜ ê±°ëŒ€í•œ ë°œì „ì†Œì²˜ëŸ¼ ì œì–´</b>í•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.
                </div>
            </div>
            <div class="slide-footer"><button class="btn-ppt" onclick="showSlide(2)">ë‹¤ìŒ â–¶</button></div>
        </div>
        <div class="slide-card" id="s2">
            <div class="slide-header">2. í•œì „ì˜ ì—­í• </div>
            <div class="slide-body">
                <div class="slide-icon">âš–ï¸</div>
                <div class="slide-box">
                    ì „ë ¥ë§ì˜ <b>ìˆ˜ìš”ì™€ ê³µê¸‰ì„ ì¼ì¹˜</b>ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.<br>
                    - ê³µê¸‰ ë¶€ì¡± â” ì •ì „ ìœ„í—˜ (ì£¼íŒŒìˆ˜ í•˜ë½)<br>
                    - ê³µê¸‰ ê³¼ì‰ â” ì„¤ë¹„ ê³ ì¥ (ì£¼íŒŒìˆ˜ ìƒìŠ¹)<br>
                    <b>ESS(ë°°í„°ë¦¬)</b>ì™€ <b>DR(ë¶€í•˜ê°ì¶•)</b>ì„ ì´ìš©í•´ ê· í˜•ì„ ë§ì¶”ì„¸ìš”.
                </div>
            </div>
            <div class="slide-footer">
                <button class="btn-ppt" onclick="showSlide(1)">â—€ ì´ì „</button>
                <button class="btn-ppt" onclick="showSlide(3)">ë‹¤ìŒ â–¶</button>
            </div>
        </div>
        <div class="slide-card" id="s3">
            <div class="slide-header">3. ê²Œì„ ë°©ë²•</div>
            <div class="slide-body">
                <div class="slide-icon">ğŸ¤–</div>
                <div class="slide-box">
                    1. <b>ìë™ ì„±ì¥:</b> ì„¤ë¹„(ê³µê¸‰)ì™€ ê³µì¥(ìˆ˜ìš”)ì€ ìë™ìœ¼ë¡œ ëŠ˜ì–´ë‚©ë‹ˆë‹¤.<br>
                    2. <b>ESS ì¦ì„¤:</b> ESS ìš©ëŸ‰ë„ ìë™ìœ¼ë¡œ ì»¤ì§‘ë‹ˆë‹¤.<br>
                    3. <b>AI ëª¨ë“œ:</b> ì–´ë ¤ìš°ë©´ [AI ìë™ìš´ì „]ì„ ì¼œì„¸ìš”.<br>
                    <br>
                    â€» íŠœí† ë¦¬ì–¼ ì‹¤ìŠµ í›„ ì‹¤ì „ì— íˆ¬ì…ë©ë‹ˆë‹¤.
                </div>
            </div>
            <div class="slide-footer">
                <button class="btn-ppt" onclick="showSlide(2)">â—€ ì´ì „</button>
                <button class="btn-ppt btn-start" onclick="startGame()">í›ˆë ¨ ì‹œì‘ ğŸš€</button>
            </div>
        </div>
    </div>

    <header>
        <div class="logo">âš¡ KEPCO <span>VPP</span></div>
        <div class="status-bar">
            <div class="coin-box">
                <svg class="coin-svg" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,5.5A6.5,6.5 0 0,0 5.5,12A6.5,6.5 0 0,0 12,18.5A6.5,6.5 0 0,0 18.5,12A6.5,6.5 0 0,0 12,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7Z"/></svg>
                <span style="color:#ffd700; font-weight:bold;" id="ui-coin">0</span>
            </div>
            <div class="metric"><label>FREQ</label><span id="ui-freq" style="color:var(--primary)">60.0</span>Hz</div>
        </div>
    </header>

    <div id="container">
        <div id="map-area">
            <canvas id="gameCanvas"></canvas>
            <div id="forecast-banner"></div>
            <div id="guide-overlay"></div>
        </div>

        <div id="panel">
            <div id="ai-box">
                <div class="ai-icon">ğŸ¤–</div>
                <div class="ai-msg" id="ai-text">ëŒ€ê¸° ì¤‘...</div>
            </div>

            <div class="ai-switch" id="btn-auto" onclick="toggleAuto()">â— AI ìë™ ìš´ì „ (OFF)</div>

            <div class="card">
                <div class="card-title">ğŸ“Š ìˆ˜ê¸‰ (Grid)</div>
                <div class="res-grid">
                    <span>âš¡ ê³µê¸‰ <span id="val-sup" style="color:var(--success)">0</span></span>
                    <span>ğŸ¢ ìˆ˜ìš” <span id="val-dem" style="color:var(--danger)">0</span></span>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ›ï¸ ì œì–´ (ESS: <span id="val-soc">50%</span>)</div>
                <div style="background:#000; height:6px; border-radius:3px; margin-bottom:10px;">
                    <div id="bar-soc" style="width:50%; height:100%; background:var(--success); transition:0.3s;"></div>
                </div>
                <div class="btn-grid">
                    <button class="ctrl-btn c-charge" id="btn-c" onclick="manual('charge')">ì¶©ì „</button>
                    <button class="ctrl-btn c-discharge" id="btn-d" onclick="manual('discharge')">ë°©ì „</button>
                    <button class="ctrl-btn c-dr" id="btn-dr" onclick="toggleDR()">ğŸ­ DR ë°œë ¹</button>
                    <button class="ctrl-btn c-cut" id="btn-cut" onclick="toggleCut()">âœ‚ï¸ ì¶œë ¥ì œì–´</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ—ï¸ ì„¤ë¹„ í˜„í™© (ìë™ì¦ì„¤)</div>
                <div class="res-grid">
                    <span>â˜€ï¸ íƒœì–‘ê´‘ <span id="cnt-s">0</span></span>
                    <span>ğŸŒ€ í’ë ¥ <span id="cnt-w">0</span></span>
                    <span>ğŸ¢ ì•„íŒŒíŠ¸ <span id="cnt-a">0</span></span>
                    <span>ğŸ­ ê³µì¥ <span id="cnt-f">0</span></span>
                    <span>ğŸ”‹ ESS <span id="cnt-e">0</span></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Setup ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let isRunning = false, isAuto = false, mode = 'PPT';
        let time = 720, level = 1, coin = 0, freq = 60.00;
        let supply = 0, demand = 0;
        let essCap = 2000, essLevel = 1000, action = 'stop', drOn=false, cutOn=false;
        let step = 0; // Tutorial step

        const nodes = [
            {id:'seoul', name:'ìˆ˜ë„ê¶Œ', x:0.35, y:0.25, c:'#ef5350'},
            {id:'gangwon', name:'ê°•ì›', x:0.7, y:0.2, c:'#42a5f5'},
            {id:'chungcheong', name:'ì¶©ì²­', x:0.4, y:0.45, c:'#ffa726'},
            {id:'honam', name:'í˜¸ë‚¨', x:0.3, y:0.7, c:'#ab47bc'},
            {id:'yeongnam', name:'ì˜ë‚¨', x:0.75, y:0.65, c:'#26c6da'},
            {id:'jeju', name:'ì œì£¼', x:0.3, y:0.92, c:'#66bb6a'}
        ];
        let objects = [];

        // --- Resize ---
        function resize() {
            if(!canvas) return;
            canvas.width = document.getElementById('map-area').clientWidth;
            canvas.height = document.getElementById('map-area').clientHeight;
        }
        window.addEventListener('resize', resize);

        // --- UI Logic ---
        function showSlide(n) {
            document.querySelectorAll('.slide-card').forEach(e=>e.classList.remove('active'));
            document.getElementById('s'+n).classList.add('active');
        }

        function startGame() {
            document.getElementById('intro-overlay').style.display = 'none';
            resize();
            isRunning = true;
            mode = 'TUTORIAL';
            
            // ì´ˆê¸° ì„¤ë¹„
            objects = [];
            essLevel = 1000; coin = 0;
            
            startTutorial();
            gameLoop();
        }

        // --- Tutorial ---
        function startTutorial() {
            setStep(1);
            // íŠœí† ë¦¬ì–¼ ì¤‘ì—” ë²„íŠ¼ ì ê¸ˆ
            lockBtns(true);
        }

        function setStep(s) {
            step = s;
            const g = document.getElementById('guide-overlay');
            g.style.display = 'block';
            
            if(s===1) {
                g.innerHTML = "STEP 1: í˜¸ë‚¨ì— <span style='color:#facc15'>íƒœì–‘ê´‘</span>ì´ ê±´ì„¤ë©ë‹ˆë‹¤. (í„°ì¹˜)";
                // í´ë¦­ ìœ ë„ (ì‹¤ì œ ê±´ì„¤ì€ í´ë¦­ ì‹œ)
            } else if(s===2) {
                g.innerHTML = "STEP 2: ì œì£¼ì— <span style='color:#00d2ff'>í’ë ¥</span>ì´ ê±´ì„¤ë©ë‹ˆë‹¤. (í„°ì¹˜)";
            } else if(s===3) {
                g.innerHTML = "STEP 3: ìˆ˜ë„ê¶Œì— <span style='color:#00e676'>ESS</span>ê°€ ê±´ì„¤ë©ë‹ˆë‹¤. (í„°ì¹˜)";
            } else if(s===4) {
                g.innerHTML = "STEP 4: ìš°ì¸¡ íŒ¨ë„ì˜ <span style='color:#ff5252'>[ì¶©ì „]</span> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.";
                document.getElementById('btn-c').style.opacity = '1';
                document.getElementById('btn-c').style.pointerEvents = 'auto';
            }
        }

        function endTutorial() {
            mode = 'REAL';
            document.getElementById('guide-overlay').style.display = 'none';
            alert("ğŸ‰ íŠœí† ë¦¬ì–¼ ì™„ë£Œ! ì‹¤ì „ ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.\n(ìë™ ì„±ì¥ & AI ì‚¬ìš© ê°€ëŠ¥)");
            lockBtns(false);
            money = 5000;
            level = 1;
            // ê¸°ë³¸ ì„¤ë¹„ ì¶”ê°€
            spawn('apt', 'seoul', 5);
            spawn('factory', 'yeongnam', 2);
        }

        // --- Game Loop ---
        function gameLoop() {
            if(!isRunning) return;
            update();
            draw();
            updateUI();
            requestAnimationFrame(gameLoop);
        }

        function update() {
            // Time & Level
            time += 0.1; // ë§¤ìš° ëŠë¦¼
            if(time>=1440) { time=0; if(mode==='REAL') levelUp(); }

            // Logic
            let h = time/60;
            let curve = (h>9&&h<21)?1.3:0.7;
            let baseL = 2000 + (level*100);
            
            // ê°ì²´ ê¸°ë°˜ ë¶€í•˜/ë°œì „
            let addL=0, addG=0;
            objects.forEach(o=>{
                if(o.t==='apt') addL+=50;
                if(o.t==='fac') addL+=200;
                
                if(o.t==='s') addG += 200 * (h>7&&h<18 ? Math.sin((h-7)/11*Math.PI) : 0);
                if(o.t==='w') addG += 250 * (0.5 + Math.sin(time*0.02)*0.3);
            });

            demand = Math.floor((baseL+addL)*curve * (drOn?0.8:1));
            
            // ê¸°ë³¸ë°œì „ + ì‹ ì¬ìƒ
            let baseG = 2500 + (level*50); 
            let totalG = baseG + addG;
            if(cutOn) totalG *= 0.7;

            // ESS
            // ESS ìš©ëŸ‰ë„ ìë™ì¦ì„¤ (ì˜¤ë¸Œì íŠ¸ ìˆ˜ ë¹„ë¡€ or ë ˆë²¨ ë¹„ë¡€)
            let essCount = objects.filter(o=>o.t==='e').length;
            essCap = 2000 + (essCount * 1000); 
            
            // AI Logic
            if(isAuto && mode==='REAL') {
                aiControl(totalG, demand);
            }

            let flow = 0;
            if(action==='charge') flow = -1000;
            if(action==='discharge') flow = 1000;
            
            essLevel -= flow * 0.02; // ì†ë„ ëŠë¦¼
            essLevel = Math.max(0, Math.min(essLevel, essCap));
            
            supply = Math.floor(totalG + flow);

            // Freq
            let diff = supply - demand;
            freq += diff * 0.00005;
            freq += (60 - freq) * 0.05;

            if(freq>=59.9 && freq<=60.1) coin += 0.1;
        }

        function levelUp() {
            if(level>=20) return;
            level++;
            // ìë™ ì¦ì„¤
            spawn('s','honam',1); spawn('w','gangwon',1); spawn('apt','seoul',2);
            // ESSë„ ìë™ ì¦ì„¤
            spawn('e','seoul',1);
            
            let b = document.getElementById('forecast-banner');
            b.style.display='block'; b.innerText = `ğŸ“¢ Level ${level}: ì„¤ë¹„ê°€ ìë™ ì¦ì„¤ë˜ì—ˆìŠµë‹ˆë‹¤!`;
            setTimeout(()=>b.style.display='none', 3000);
        }

        function aiControl(g, l) {
            let msg = "";
            if(g > l + 100) {
                if(essLevel < essCap) { action='charge'; cutOn=false; msg="âš¡ ê³µê¸‰ ê³¼ì‰! ESS ì¶©ì „ ì¤‘"; }
                else { action='stop'; cutOn=true; msg="âœ‚ï¸ ESS ë§Œì¶©! ì¶œë ¥ì œì–´ ì‹œí–‰"; }
            } else if(g < l - 50) {
                if(essLevel > 0) { action='discharge'; drOn=false; msg="ğŸ’¡ ê³µê¸‰ ë¶€ì¡±! ESS ë°©ì „ ì¤‘"; }
                else { action='stop'; drOn=true; msg="ğŸš¨ ESS ê³ ê°ˆ! DR ë°œë ¹"; }
            } else {
                action='stop'; cutOn=false; drOn=false; msg="âœ… ìˆ˜ê¸‰ ì•ˆì •ì ";
            }
            document.getElementById('ai-text').innerText = msg;
            updateBtns();
        }

        // --- Input ---
        function toggleAuto() {
            isAuto = !isAuto;
            let btn = document.getElementById('btn-auto');
            btn.classList.toggle('on', isAuto);
            btn.innerText = isAuto ? "â— AI ìë™ ìš´ì „ (ON)" : "â— AI ìë™ ìš´ì „ (OFF)";
            if(!isAuto) { action='stop'; drOn=false; cutOn=false; updateBtns(); document.getElementById('ai-text').innerText="ìˆ˜ë™ ëª¨ë“œì…ë‹ˆë‹¤."; }
        }

        function manual(a) {
            if(isAuto) return;
            action = (action===a)?'stop':a; updateBtns();
            // íŠœí† ë¦¬ì–¼ ì™„ë£Œ íŠ¸ë¦¬ê±°
            if(mode==='TUTORIAL' && step===4 && action==='charge') endTutorial();
        }
        function toggleDR() { if(!isAuto) { drOn=!drOn; updateBtns(); } }
        function toggleCut() { if(!isAuto) { cutOn=!cutOn; updateBtns(); } }

        function updateBtns() {
            document.querySelectorAll('.ctrl-btn').forEach(b=>b.classList.remove('active'));
            if(action==='charge') document.getElementById('btn-c').classList.add('active');
            if(action==='discharge') document.getElementById('btn-d').classList.add('active');
            if(drOn) document.getElementById('btn-dr').classList.add('active');
            if(cutOn) document.getElementById('btn-cut').classList.add('active');
        }

        function lockBtns(lock) {
            document.querySelectorAll('.ctrl-btn').forEach(b => {
                b.style.pointerEvents = lock ? 'none' : 'auto';
                b.style.opacity = lock ? 0.2 : 1;
            });
        }

        // íŠœí† ë¦¬ì–¼ìš© ë§µ í´ë¦­
        canvas.addEventListener('mousedown', e => {
            if(mode !== 'TUTORIAL') return;
            let rect = canvas.getBoundingClientRect();
            let mx=(e.clientX-rect.left)/rect.width; let my=(e.clientY-rect.top)/rect.height;
            
            // íŠœí† ë¦¬ì–¼ ë‹¨ê³„ë³„ í´ë¦­ ì˜ì—­ í™•ì¸ (ê°„ëµí™”)
            if(step===1) { spawn('s','honam',1); setStep(2); }
            else if(step===2) { spawn('w','jeju',1); setStep(3); }
            else if(step===3) { spawn('e','seoul',1); setStep(4); }
        });

        function spawn(type, rid, n) {
            let node = nodes.find(x=>x.id===rid);
            for(let i=0; i<n; i++) {
                objects.push({t:type, x:node.x+(Math.random()-.5)*0.1, y:node.y+(Math.random()-.5)*0.1, p:Math.random()*10});
            }
        }

        // --- Draw ---
        function draw() {
            let w=canvas.width; let h=canvas.height;
            ctx.clearRect(0,0,w,h);

            // ì—°ê²°ì„ 
            ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.lineWidth=2;
            ctx.beginPath();
            let c = getNodePos('chungcheong');
            nodes.forEach(n=>{
                if(n.id!=='chungcheong' && n.id!=='jeju') {
                    let p = getNodePos(n.id); ctx.moveTo(c.x, c.y); ctx.lineTo(p.x, p.y);
                }
            });
            let p1=getNodePos('honam'), p2=getNodePos('jeju'); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
            ctx.stroke();

            // ë…¸ë“œ
            nodes.forEach(n => {
                let p = getNodePos(n.id);
                ctx.beginPath(); ctx.arc(p.x, p.y, w*0.08, 0, Math.PI*2);
                ctx.fillStyle = n.c; ctx.globalAlpha = 0.2; ctx.fill();
                ctx.strokeStyle = n.c; ctx.globalAlpha = 1; ctx.lineWidth=2; ctx.stroke();
                
                ctx.fillStyle='#fff'; ctx.font='bold 14px sans-serif'; ctx.textAlign='center';
                ctx.fillText(n.name, p.x, p.y);
            });

            // ì•„ì´ì½˜
            objects.forEach(o => {
                let px=o.x*w; let py=o.y*h;
                let icon = o.t==='s'?'â˜€ï¸':(o.t==='w'?'ğŸŒ€':(o.t==='e'?'ğŸ”‹':(o.t==='apt'?'ğŸ¢':'ğŸ­')));
                let float = Math.sin(Date.now()*0.003 + o.p)*3;
                ctx.font='20px Arial'; ctx.fillText(icon, px, py+float);
            });
        }

        function getNodePos(id) {
            let w=canvas.width; let h=canvas.height;
            let n=nodes.find(x=>x.id===id);
            // ì¤‘ì•™ì •ë ¬ ë³´ì •
            let s = Math.min(w, h);
            let ox = (w-s)/2; let oy = (h-s)/2;
            return {x:n.x*s + ox, y:n.y*s + oy};
        }

        // --- UI ---
        function updateUI() {
            let hh=Math.floor(time/60).toString().padStart(2,'0');
            let mm=Math.floor(time%60).toString().padStart(2,'0');
            document.getElementById('ui-time').innerText = `${hh}:${mm}`;
            document.getElementById('ui-coin').innerText = Math.floor(coin);
            document.getElementById('ui-level').innerText = level;
            
            document.getElementById('val-sup').innerText = supply;
            document.getElementById('val-dem').innerText = demand;
            document.getElementById('val-soc').innerText = Math.floor(essLevel/essCap*100)+"%";
            document.getElementById('bar-soc').style.width = (essLevel/essCap*100)+"%";

            let fEl=document.getElementById('ui-freq');
            fEl.innerText = freq.toFixed(2);
            fEl.style.color = (freq<59.8||freq>60.2)?'var(--danger)':'var(--primary)';

            // Count
            document.getElementById('cnt-s').innerText = objects.filter(o=>o.t==='s').length;
            document.getElementById('cnt-w').innerText = objects.filter(o=>o.t==='w').length;
            document.getElementById('cnt-a').innerText = objects.filter(o=>o.t==='apt').length;
            document.getElementById('cnt-f').innerText = objects.filter(o=>o.t==='fac').length;
            document.getElementById('cnt-e').innerText = objects.filter(o=>o.t==='e').length;
        }
    </script>
</body>
</html>
