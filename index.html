<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê°€ìƒë°œì „ì†Œ VPP</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #101418; --panel: #1c232e; --primary: #00d2ff; --accent: #ffc107; --danger: #ff5252; --success: #00e676; --text: #fff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: 'Noto Sans KR', sans-serif; display: flex; flex-direction: column; height: 100vh; user-select: none; }

        /* ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ ëŒ€ì‘ */
        @media (max-width: 768px) {
            #container { flex-direction: column !important; }
            #panel { width: 100% !important; height: 45% !important; order: 2; border-right: none !important; border-top: 1px solid #333; overflow-y: auto; }
            #map-area { height: 55% !important; order: 1; }
            header { height: 50px !important; padding: 0 15px !important; }
            .logo { font-size: 18px !important; }
            .slide-card { width: 90% !important; height: auto !important; min-height: 300px; padding: 20px !important; }
        }

        /* UI ìŠ¤íƒ€ì¼ */
        header { height: 60px; background: #151a24; border-bottom: 2px solid var(--primary); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; z-index: 100; }
        .logo { font-family: 'Jua'; font-size: 24px; } .logo span { color: var(--primary); }
        .status-bar { display: flex; gap: 15px; align-items: center; font-size: 14px; }
        .coin-box { display: flex; align-items: center; gap: 5px; background: rgba(255,215,0,0.15); padding: 5px 12px; border-radius: 20px; border: 1px solid gold; }
        
        #container { display: flex; flex: 1; height: 100%; }
        #panel { width: 360px; background: var(--panel); border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 10; overflow-y: auto; }
        .card { background: #252d3d; padding: 12px; border-radius: 10px; border: 1px solid #333; }
        .card-title { font-size: 14px; font-weight: bold; color: var(--primary); margin-bottom: 8px; border-bottom: 1px solid #444; padding-bottom: 4px; }
        
        /* ë²„íŠ¼ ê·¸ë¦¬ë“œ */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .ctrl-btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; color: #fff; opacity: 0.4; font-family: 'Jua'; font-size: 14px; background: #333; }
        .ctrl-btn.active { opacity: 1; transform: scale(1.02); box-shadow: 0 0 10px currentColor; }
        .c-charge { background: var(--danger); } .c-discharge { background: var(--success); }
        .c-dr { background: #9c27b0; grid-column: span 2; } .c-cut { background: #ff9800; grid-column: span 2; }

        #map-area { flex: 1; position: relative; background: radial-gradient(circle, #1b263b 0%, #0b0c15 100%); overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }

        /* AI & Overlay */
        #ai-box { background: #fff; color: #000; padding: 10px; border-radius: 10px; border: 3px solid var(--primary); display: flex; align-items: center; gap: 10px; min-height: 40px; }
        #forecast-banner { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); border: 2px solid var(--accent); color: var(--accent); padding: 10px 20px; border-radius: 30px; font-size: 16px; display: none; white-space: nowrap; z-index: 50; }
        
        /* Intro */
        #intro-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.98); z-index:9999; display:flex; justify-content:center; align-items:center; }
        .slide-card { background:#fff; color:#333; width:90%; max-width:600px; height:400px; border-radius:15px; padding:20px; display:none; flex-direction:column; justify-content: space-between; text-align: center;}
        .slide-card.active { display:flex; }
        .btn-ppt { background: #0054a6; color: #fff; border:none; padding:15px 30px; border-radius:8px; font-weight:bold; cursor:pointer; font-size: 18px; margin-top:auto; width: 100%;}
        
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 12px; }
    </style>
</head>
<body>
    <div id="intro-overlay">
        <div class="slide-card active" id="s1">
            <div>
                <h2 style="color:#0054a6; margin-top:0;">1. VPP êµìœ¡ ì‹œë®¬ë ˆì´í„°</h2>
                <div style="font-size:60px; margin: 20px 0;">ğŸ“</div>
                <p style="font-size: 16px; line-height: 1.5;">ë°˜ê°‘ìŠµë‹ˆë‹¤! ë³¸ ê²Œì„ì€ <b>ê°€ìƒë°œì „ì†Œ ìš´ì˜</b>ì„ í•™ìŠµí•˜ëŠ” ëª¨ë°”ì¼ ì›¹ì•±ì…ë‹ˆë‹¤.<br>í™”ë©´ì„ í„°ì¹˜í•˜ì—¬ ì§„í–‰í•˜ì„¸ìš”.</p>
            </div>
            <button class="btn-ppt" onclick="showSlide(2)">ë‹¤ìŒ â–¶</button>
        </div>

        <div class="slide-card" id="s2">
            <div>
                <h2 style="color:#0054a6; margin-top:0;">2. ê²Œì„ ê·œì¹™</h2>
                <div style="font-size: 16px; line-height: 1.8; text-align: left; background: #f0f4f8; padding: 15px; border-radius: 10px;">
                    1. <b>ìë™ ì„±ì¥:</b> ì„¤ë¹„ëŠ” ì‹œê°„ì´ ì§€ë‚˜ë©´ ì €ì ˆë¡œ ëŠ˜ì–´ë‚©ë‹ˆë‹¤.<br>
                    2. <b>ìœ„ê¸° ê´€ë¦¬:</b> ì „ê¸°ê°€ ë¶€ì¡±í•˜ë©´ [ë°©ì „], ë‚¨ìœ¼ë©´ [ì¶©ì „]í•˜ì„¸ìš”.<br>
                    3. <b>AI íŒ:</b> ì¢Œì¸¡(í˜¹ì€ í•˜ë‹¨) AIì˜ ì¡°ì–¸ì„ ë”°ë¥´ì„¸ìš”.
                </div>
            </div>
            <button class="btn-ppt" style="background:#00c853;" onclick="startGame()">í›ˆë ¨ ì‹œì‘ ğŸš€</button>
        </div>
    </div>

    <header>
        <div class="logo">âš¡ KEPCO</div>
        <div class="status-bar">
            <div class="coin-box">ğŸª™ <span id="ui-coin">0</span></div>
            <div>LV.<span id="ui-level">1</span></div>
            <div style="color:var(--primary)"><span id="ui-freq">60.0</span>Hz</div>
        </div>
    </header>

    <div id="container">
        <div id="map-area">
            <canvas id="gameCanvas"></canvas>
            <div id="forecast-banner">ğŸ“¢ ì˜ˆë³´: íƒœì–‘ê´‘ ë°œì „ ê¸‰ì¦!</div>
        </div>
        <div id="panel">
            <div id="ai-box">
                <span style="font-size:24px">ğŸ¤–</span><span id="ai-text" style="font-weight:bold; font-size:13px">ì¤€ë¹„ ì™„ë£Œ.</span>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“Š ìˆ˜ê¸‰ í˜„í™©</div>
                <div class="res-grid">
                    <span>âš¡ê³µê¸‰: <span id="val-sup" style="color:var(--success)">0</span></span>
                    <span>ğŸ¢ìˆ˜ìš”: <span id="val-dem" style="color:var(--danger)">0</span></span>
                </div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ›ï¸ VPP ì œì–´ (ë°°í„°ë¦¬: <span id="val-soc">50</span>%)</div>
                <div class="btn-grid">
                    <button class="ctrl-btn c-charge" id="btn-c" onclick="act('c')">ì¶©ì „</button>
                    <button class="ctrl-btn c-discharge" id="btn-d" onclick="act('d')">ë°©ì „</button>
                    <button class="ctrl-btn c-dr" id="btn-dr" onclick="tog('dr')">DR ë°œë ¹</button>
                    <button class="ctrl-btn c-cut" id="btn-cut" onclick="tog('cut')">ì¶œë ¥ì œì–´</button>
                </div>
            </div>
            <div class="card" style="opacity:0.7">
                <div class="card-title">ğŸ—ï¸ ì„¤ë¹„ (ìë™ì¦ì„¤)</div>
                <div class="res-grid">
                    <span>â˜€ï¸ íƒœì–‘ê´‘ <span id="cnt-s">0</span></span>
                    <span>ğŸŒ€ í’ë ¥ <span id="cnt-w">0</span></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Service Worker ë“±ë¡ (PWA í•„ìˆ˜)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let w, h, scale, offX, offY;
        
        // Game State
        let run = false, time = 720, level = 1, coin = 0, freq = 60.0;
        let supply = 0, demand = 0, essL = 1000, essC = 2000;
        let action = 'stop', dr = false, cut = false;
        let nodes = [
            {id:'s', x:0.35, y:0.25, c:'#ef5350', t:'load'}, {id:'g', x:0.7, y:0.2, c:'#42a5f5', t:'wind'},
            {id:'c', x:0.4, y:0.45, c:'#ffa726', t:'hub'}, {id:'h', x:0.3, y:0.7, c:'#ab47bc', t:'solar'},
            {id:'y', x:0.75, y:0.65, c:'#26c6da', t:'ind'}, {id:'j', x:0.3, y:0.92, c:'#66bb6a', t:'wind'}
        ];
        let objs = [];

        // === í™”ë©´ ì „í™˜ í•¨ìˆ˜ (ì—¬ê¸° ìˆ˜ì •ë¨) ===
        function showSlide(n) {
            document.querySelectorAll('.slide-card').forEach(e => e.style.display = 'none');
            document.getElementById('s' + n).style.display = 'flex';
        }

        function startGame() {
            document.getElementById('intro-overlay').style.display = 'none';
            resize(); 
            run = true;
            // Init objects
            spawn('s', 'h', 3); spawn('w', 'j', 2); spawn('a', 's', 5);
            loop();
        }

        function resize() {
            if(!canvas) return;
            w = canvas.width = document.getElementById('map-area').clientWidth;
            h = canvas.height = document.getElementById('map-area').clientHeight;
            let s = Math.min(w, h);
            scale = s; offX = (w-s)/2; offY = (h-s)/2;
        }
        window.onresize = resize;

        function spawn(t, rid, n) {
            let node = nodes.find(x=>x.id===rid);
            if(!node) return;
            for(let i=0; i<n; i++) objs.push({t:t, x:node.x+(Math.random()-.5)*0.15, y:node.y+(Math.random()-.5)*0.15, p:Math.random()*10});
        }

        function loop() {
            if(!run) return;
            update(); draw();
            requestAnimationFrame(loop);
        }

        function update() {
            time += 0.2;
            if(time>=1440) { time=0; level++; spawn('s','h',2); document.getElementById('forecast-banner').style.display='block'; setTimeout(()=>{document.getElementById('forecast-banner').style.display='none'},3000); }

            // Physics
            let curve = (time/60>9 && time/60<21) ? 1.3 : 0.7;
            let baseL = 2000 + (level*100);
            demand = baseL * curve * (dr ? 0.8 : 1);

            let baseG = 2500 + (level*50);
            let sun = (time/60>7 && time/60<18) ? 1 : 0;
            let reG = (objs.filter(o=>o.t==='s').length*200*sun) + (objs.filter(o=>o.t==='w').length*200*0.5);
            let totalG = baseG + reG; if(cut) totalG *= 0.7;

            essC = 2000 + level*300;
            let flow = 0;
            if(action==='c' && essL<essC) flow = -1000;
            if(action==='d' && essL>0) flow = 1000;
            
            essL -= flow*0.01; // Slow battery
            essL = Math.max(0, Math.min(essL, essC));
            supply = Math.floor(totalG + flow);

            let diff = supply - demand;
            freq += diff * 0.00005;
            freq += (60 - freq) * 0.05;
            
            if(freq>=59.8 && freq<=60.2) coin++;

            // AI & UI
            let ai = document.getElementById('ai-text');
            let box = document.getElementById('ai-box');
            if(freq < 59.7) { ai.innerText = "âš ï¸ ì „ë ¥ ë¶€ì¡±! [ë°©ì „]í•˜ì„¸ìš”!"; box.style.borderColor = "red"; }
            else if(freq > 60.3) { ai.innerText = "âš ï¸ ì „ë ¥ ê³¼ì‰! [ì¶©ì „]í•˜ì„¸ìš”!"; box.style.borderColor = "cyan"; }
            else { ai.innerText = "ì•ˆì •ì ì…ë‹ˆë‹¤. (ì½”ì¸ ì±„êµ´ì¤‘)"; box.style.borderColor = "#ccc"; }

            document.getElementById('ui-coin').innerText = coin;
            document.getElementById('ui-level').innerText = level;
            document.getElementById('ui-freq').innerText = freq.toFixed(1);
            document.getElementById('val-sup').innerText = Math.floor(supply);
            document.getElementById('val-dem').innerText = Math.floor(demand);
            document.getElementById('val-soc').innerText = Math.floor(essL/essC*100);
            document.getElementById('cnt-s').innerText = objs.filter(o=>o.t==='s').length;
            document.getElementById('cnt-w').innerText = objs.filter(o=>o.t==='w').length;
        }

        function act(a) { action = (action===a)?'stop':a; updBtn(); }
        function tog(t) { if(t==='dr') dr=!dr; if(t==='cut') cut=!cut; updBtn(); }
        function updBtn() {
            document.querySelectorAll('.ctrl-btn').forEach(b=>b.classList.remove('active'));
            if(action==='c') document.getElementById('btn-c').classList.add('active');
            if(action==='d') document.getElementById('btn-d').classList.add('active');
            if(dr) document.getElementById('btn-dr').classList.add('active');
            if(cut) document.getElementById('btn-cut').classList.add('active');
        }

        function draw() {
            ctx.fillStyle = '#0b0c15'; ctx.fillRect(0,0,w,h);
            
            // Map Nodes
            nodes.forEach(n => {
                let cx = n.x * scale + offX;
                let cy = n.y * scale + offY;
                ctx.beginPath(); ctx.arc(cx, cy, 40, 0, Math.PI*2);
                ctx.fillStyle = n.c; ctx.globalAlpha = 0.2; ctx.fill();
                ctx.strokeStyle = n.c; ctx.globalAlpha = 1; ctx.lineWidth = 2; ctx.stroke();
                
                // Name
                ctx.fillStyle = '#fff'; ctx.font = 'bold 14px sans-serif'; ctx.textAlign='center';
                ctx.fillText(n.id.toUpperCase(), cx, cy+5);
            });

            // Objects
            objs.forEach(o => {
                let cx = o.x * scale + offX;
                let cy = o.y * scale + offY;
                let icon = o.t==='s'?'â˜€ï¸':(o.t==='w'?'ğŸŒ€':(o.t==='a'?'ğŸ¢':'ğŸ­'));
                let float = Math.sin(Date.now()*0.003 + o.p) * 3;
                ctx.font = '20px Arial'; ctx.fillText(icon, cx, cy+float);
            });
        }
    </script>
</body>
</html>
