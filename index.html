<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KEPCO VPP Ultimate</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* === UI í…Œë§ˆ === */
        :root {
            --bg: #101418;
            --panel: #1c232e;
            --primary: #00d2ff;
            --accent: #ffc107;
            --danger: #ff5252;
            --success: #00e676;
            --text: #ffffff;
        }

        body {
            margin: 0; overflow: hidden; background: var(--bg);
            font-family: 'Noto Sans KR', sans-serif; color: var(--text);
            display: flex; flex-direction: column; height: 100vh; user-select: none;
        }

        /* === 1. ì¸íŠ¸ë¡œ PPT (ë‚´ìš© ë³´ê°•) === */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .slide-card {
            width: 90%; max-width: 800px; height: 90%; max-height: 600px; background: #fff; color: #333;
            border-radius: 20px; padding: 30px; box-sizing: border-box;
            display: none; flex-direction: column;
            box-shadow: 0 0 50px rgba(0, 210, 255, 0.5);
        }
        .slide-card.active { display: flex; animation: fadeIn 0.3s; }
        
        .slide-header { 
            font-family: 'Jua', sans-serif; font-size: 28px; color: #0054a6; 
            border-bottom: 3px solid #0054a6; padding-bottom: 15px; margin-bottom: 15px; flex-shrink: 0;
        }
        .slide-body { 
            font-size: 16px; line-height: 1.6; flex: 1; overflow-y: auto;
            text-align: left; padding: 0 10px;
        }
        .slide-highlight { background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 5px solid #0054a6; }
        .slide-icon { font-size: 50px; text-align: center; margin: 20px 0; }
        
        .slide-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 15px; flex-shrink: 0; }
        
        .btn-ppt {
            padding: 12px 25px; border: none; border-radius: 8px; font-size: 16px; 
            background: #0054a6; color: white; font-family: 'Jua'; cursor: pointer;
        }
        .btn-start { background: var(--success); color: #000; box-shadow: 0 5px 15px rgba(0,230,118,0.4); }

        @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }

        /* === 2. ë©”ì¸ í—¤ë” === */
        header {
            height: 60px; background: #151a24; border-bottom: 2px solid var(--primary);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 100;
        }
        .logo { font-family: 'Jua'; font-size: 22px; color: #fff; display: flex; align-items: center; gap: 5px; }
        .logo span { color: var(--primary); }

        .status-bar { display: flex; gap: 15px; align-items: center; }
        
        .coin-box {
            display: flex; align-items: center; gap: 5px; background: rgba(255, 215, 0, 0.15);
            padding: 5px 15px; border-radius: 20px; border: 1px solid gold;
        }
        .coin-svg { width: 20px; height: 20px; fill: gold; filter: drop-shadow(0 0 2px gold); }
        .coin-text { font-size: 18px; font-weight: bold; color: gold; font-family: 'Consolas'; }

        .combo-box { font-family: 'Jua'; color: var(--accent); font-size: 18px; display: none; animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { from{transform:scale(1);} to{transform:scale(1.2);} }

        .metric { text-align: center; display: none; } /* ëª¨ë°”ì¼ ê³µê°„í™•ë³´ */
        @media (min-width: 600px) { .metric { display: block; } }
        .metric span { font-size: 18px; font-weight: bold; font-family: 'Consolas'; }

        /* === 3. ë©”ì¸ ë ˆì´ì•„ì›ƒ === */
        #container { display: flex; flex: 1; height: 100%; overflow: hidden; }
        /* ëª¨ë°”ì¼ ì„¸ë¡œ ëª¨ë“œ ëŒ€ì‘ */
        @media (max-width: 768px) {
            #container { flex-direction: column; }
            #panel { width: 100% !important; height: 45%; border-left: none; border-top: 1px solid #333; }
            #map-area { height: 55%; }
        }

        /* íŒ¨ë„ */
        #panel {
            width: 360px; background: var(--panel); border-right: 1px solid #333;
            padding: 15px; display: flex; flex-direction: column; gap: 10px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.2); z-index: 10; overflow-y: auto;
        }
        .card { background: #252d3d; padding: 12px; border-radius: 10px; border: 1px solid #333; }
        .card-title { font-size: 14px; font-weight: bold; color: var(--primary); margin-bottom: 8px; border-bottom: 1px solid #444; padding-bottom: 4px; display: flex; justify-content: space-between; }

        /* AI ë©”ì‹œì§€ (êµìœ¡ìš©) */
        #ai-box {
            background: #fff; color: #000; padding: 10px; border-radius: 10px;
            border-left: 5px solid var(--primary); display: flex; align-items: center; gap: 10px;
            min-height: 50px; transition: 0.3s;
        }
        .ai-face { font-size: 30px; }
        .ai-msg { font-weight: bold; font-size: 13px; line-height: 1.3; }

        /* ì„¤ë¹„ í˜„í™© */
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 12px; }
        .res-item span:last-child { float: right; color: var(--success); font-weight: bold; }

        /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        .ctrl-btn {
            padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;
            color: #fff; opacity: 0.4; transition: 0.2s; font-family: 'Jua'; font-size: 14px;
        }
        .ctrl-btn.active { opacity: 1; transform: scale(1.05); box-shadow: 0 0 10px currentColor; }
        
        .c-charge { background: var(--danger); }
        .c-discharge { background: var(--success); }
        .c-dr { background: #9c27b0; grid-column: span 2; }
        .c-cut { background: #ff9800; grid-column: span 2; }

        .ai-switch {
            background: #333; color: #aaa; padding: 8px; border-radius: 8px; text-align: center;
            cursor: pointer; font-weight: bold; border: 1px solid #555; margin-bottom: 5px; font-size: 13px;
        }
        .ai-switch.on { background: var(--success); color: #000; border-color: #fff; }

        /* ì§€ë„ */
        #map-area {
            flex: 1; position: relative; background: radial-gradient(circle at 50% 50%, #1b263b 0%, #0b0c15 100%);
            overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* íŠœí† ë¦¬ì–¼ ê°€ì´ë“œ */
        #guide-overlay {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.95); border: 2px solid var(--accent); color: #fff;
            padding: 10px 20px; border-radius: 30px; font-size: 16px; font-weight: bold;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); pointer-events: none; display: none; z-index: 50;
            white-space: nowrap; text-align: center;
        }

        /* ë‚ ì”¨/ì´ë²¤íŠ¸ ë°°ë„ˆ */
        #event-banner {
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 87, 34, 0.9); color: #fff;
            padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 14px;
            display: none; animation: slideDown 0.5s; z-index: 40;
        }
        @keyframes slideDown { from{top:-50px} to{top:70px} }

        #weather-icon {
            position: absolute; top: 10px; right: 10px; font-size: 40px; filter: drop-shadow(0 0 5px #fff);
        }

    </style>
</head>
<body>

    <div id="intro-overlay">
        <div class="slide-card active" id="slide-1">
            <div class="slide-header">1. ê°€ìƒë°œì „ì†Œ(VPP)ë€?</div>
            <div class="slide-body">
                <div class="slide-highlight">
                    <b>ğŸ’¡ ì •ì˜ (Definition)</b><br>
                    ICT ê¸°ìˆ ì„ í™œìš©í•´ ì „êµ­ì— í©ì–´ì§„ ì†Œê·œëª¨ ì—ë„ˆì§€ ìì›(íƒœì–‘ê´‘, í’ë ¥, ESS ë“±)ì„ ì—°ê²°í•˜ì—¬, ë§ˆì¹˜ <b>í•˜ë‚˜ì˜ ë°œì „ì†Œì²˜ëŸ¼ í†µí•© ì œì–´</b>í•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.
                </div>
                <p>
                    <b>[ì™œ í•„ìš”í•œê°€ìš”?]</b><br>
                    ê¸°í›„ ìœ„ê¸°ë¡œ ì¸í•´ ì¬ìƒì—ë„ˆì§€ê°€ ê¸‰ì¦í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br>
                    í•˜ì§€ë§Œ ë‚ ì”¨ì— ë”°ë¼ ë°œì „ëŸ‰ì´ ë“¤ì‘¥ë‚ ì‘¥í•˜ì—¬ ì „ë ¥ë§ì´ ë¶ˆì•ˆì •í•´ì§‘ë‹ˆë‹¤.<br>
                    VPPëŠ” ì´ë¥¼ ì˜ˆì¸¡í•˜ê³  ì œì–´í•˜ì—¬ <b>ì •ì „ì„ ë§‰ê³  ì•ˆì •ì ì¸ ì „ë ¥ì„ ê³µê¸‰</b>í•©ë‹ˆë‹¤.
                </p>
            </div>
            <div class="slide-footer"><button class="btn-ppt" onclick="nextSlide(2)">ë‹¤ìŒ â–¶</button></div>
        </div>
        <div class="slide-card" id="slide-2">
            <div class="slide-header">2. í•œì „(KEPCO)ì˜ ì—­í• </div>
            <div class="slide-body">
                <div class="slide-icon">âš–ï¸ 60Hz</div>
                <p>
                    ì „ë ¥ë§ì€ <b>ìƒì‚°ê³¼ ì†Œë¹„ì˜ ê· í˜•</b>ì´ ìƒëª…ì…ë‹ˆë‹¤.<br>
                    ì´ ê· í˜•ì´ ê¹¨ì§€ë©´ ì£¼íŒŒìˆ˜(60Hz)ê°€ í”ë“¤ë ¤ ë¸”ë™ì•„ì›ƒì´ ë°œìƒí•©ë‹ˆë‹¤.
                </p>
                <div class="slide-highlight">
                    <b>[ìš´ì˜ìì˜ í•µì‹¬ ì„ë¬´]</b><br>
                    1. <b>ê³µê¸‰ < ìˆ˜ìš” (ë¶€ì¡±):</b> ì£¼íŒŒìˆ˜ í•˜ë½ â” <span style="color:red">ì •ì „ ìœ„í—˜!</span><br>
                       ğŸ‘‰ ëŒ€ì‘: ESS ë°©ì „, DR(ê³µì¥ ê°€ë™ ì¤‘ë‹¨)<br>
                    2. <b>ê³µê¸‰ > ìˆ˜ìš” (ê³¼ì‰):</b> ì£¼íŒŒìˆ˜ ìƒìŠ¹ â” <span style="color:orange">ì„¤ë¹„ ê³ ì¥!</span><br>
                       ğŸ‘‰ ëŒ€ì‘: ESS ì¶©ì „, ì¬ìƒì—ë„ˆì§€ ì¶œë ¥ì œì–´
                </div>
            </div>
            <div class="slide-footer">
                <button class="btn-ppt" onclick="nextSlide(1)">â—€ ì´ì „</button>
                <button class="btn-ppt" onclick="nextSlide(3)">ë‹¤ìŒ â–¶</button>
            </div>
        </div>
        <div class="slide-card" id="slide-3">
            <div class="slide-header">3. í”Œë ˆì´ ê·œì¹™ & ì¬ë¯¸ìš”ì†Œ</div>
            <div class="slide-body">
                <p><b>1. ìë™ ì„±ì¥ ì‹œìŠ¤í…œ:</b> ì„¤ë¹„ëŠ” êµ­ê°€ ê³„íšì— ë”°ë¼ ìë™ìœ¼ë¡œ ê±´ì„¤ë©ë‹ˆë‹¤.</p>
                <p><b>2. AI ì½”ì¹­:</b> [AI ìë™ìš´ì „]ì„ ì¼œë©´ AIê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì œì–´ ì›ë¦¬ë¥¼ ì„¤ëª…í•´ ì¤ë‹ˆë‹¤. (êµìœ¡ìš©)</p>
                <p><b>3. ì½”ì¸ ì±„êµ´ & ì½¤ë³´:</b> ì£¼íŒŒìˆ˜ë¥¼ 60Hzë¡œ ì¼ì •í•˜ê²Œ ìœ ì§€í•˜ë©´ ì½”ì¸ì´ ì±„êµ´ë©ë‹ˆë‹¤. ì½¤ë³´ê°€ ìŒ“ì´ë©´ ì±„êµ´ëŸ‰ì´ ëŠ˜ì–´ë‚©ë‹ˆë‹¤!</p>
                <p><b>4. ë‚ ì”¨ ë³€ìˆ˜:</b> ë¹„ê°€ ì˜¤ê±°ë‚˜ í•œíŒŒê°€ ë‹¥ì¹˜ë©´ ìˆ˜ê¸‰ì´ ê¸‰ë³€í•©ë‹ˆë‹¤.</p>
                <div style="text-align:center; margin-top:20px; font-weight:bold; color:var(--success);">
                    â€» ë¨¼ì € íŠœí† ë¦¬ì–¼ì„ í†µí•´ ê¸°ì´ˆ ì¡°ì‘ì„ ìµí™ë‹ˆë‹¤.
                </div>
            </div>
            <div class="slide-footer">
                <button class="btn-ppt" onclick="nextSlide(2)">â—€ ì´ì „</button>
                <button class="btn-ppt btn-start" onclick="startGame()">íŠœí† ë¦¬ì–¼ ì‹œì‘ ğŸš€</button>
            </div>
        </div>
    </div>

    <header>
        <div class="logo">âš¡ KEPCO <span>VPP</span></div>
        <div class="status-bar">
            <div class="combo-box" id="ui-combo">ğŸ”¥ COMBO x0</div>
            <div class="coin-box">
                <svg class="coin-svg" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,5.5A6.5,6.5 0 0,0 5.5,12A6.5,6.5 0 0,0 12,18.5A6.5,6.5 0 0,0 18.5,12A6.5,6.5 0 0,0 12,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7Z" /></svg>
                <span class="coin-text" id="ui-coin">0</span>
            </div>
            <div class="metric">
                <label>FREQ</label> <span id="ui-freq" style="color:var(--primary)">60.00</span> Hz
            </div>
        </div>
    </header>

    <div id="container">
        <div id="panel">
            <div id="ai-box">
                <div class="ai-face">ğŸ¤–</div>
                <div class="ai-msg" id="ai-text">ì‹œìŠ¤í…œ ëŒ€ê¸° ì¤‘...</div>
            </div>

            <div class="ai-switch" id="btn-auto" onclick="toggleAuto()">
                â— AI ìë™ ìš´ì „ (êµìœ¡ ëª¨ë“œ)
            </div>

            <div class="card">
                <div class="card-title">ğŸ“Š ì‹¤ì‹œê°„ ìˆ˜ê¸‰</div>
                <div class="res-grid">
                    <span>âš¡ ê³µê¸‰(G)</span> <span id="val-sup" style="font-weight:bold; color:var(--success); font-family:Consolas;">0</span>
                    <span>ğŸ¢ ìˆ˜ìš”(L)</span> <span id="val-dem" style="font-weight:bold; color:var(--danger); font-family:Consolas;">0</span>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ›ï¸ VPP ì œì–´ (ESS)</div>
                <div class="btn-grid">
                    <button class="ctrl-btn c-charge" id="btn-charge" onclick="manual('charge')">ESS ì¶©ì „</button>
                    <button class="ctrl-btn c-discharge" id="btn-discharge" onclick="manual('discharge')">ESS ë°©ì „</button>
                    <button class="ctrl-btn c-dr" id="btn-dr" onclick="toggleDR()">ğŸ­ DR ë°œë ¹</button>
                    <button class="ctrl-btn c-cut" id="btn-cut" onclick="toggleCut()">âœ‚ï¸ ì¶œë ¥ì œì–´</button>
                </div>
                <div style="margin-top:10px; font-size:12px; color:#aaa;">
                    ë°°í„°ë¦¬ ì”ëŸ‰: <span id="val-soc">50%</span>
                    <div style="width:100%; height:6px; background:#000; margin-top:3px; border-radius:3px;">
                        <div id="bar-soc" style="width:50%; height:100%; background:var(--success); transition:0.3s;"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ—ï¸ ì„¤ë¹„ í˜„í™© (ìë™ì¦ì„¤)</div>
                <div class="res-grid">
                    <div>â˜€ï¸ íƒœì–‘ê´‘ <span id="cnt-solar" style="color:var(--success)">0</span></div>
                    <div>ğŸŒ€ í’ë ¥ <span id="cnt-wind" style="color:var(--success)">0</span></div>
                    <div>ğŸ¢ ì•„íŒŒíŠ¸ <span id="cnt-apt" style="color:var(--danger)">0</span></div>
                    <div>ğŸ­ ê³µì¥ <span id="cnt-fac" style="color:var(--danger)">0</span></div>
                </div>
            </div>
        </div>

        <div id="map-area">
            <canvas id="gameCanvas"></canvas>
            <div id="weather-icon">â˜€ï¸</div>
            <div id="guide-overlay"></div>
            <div id="event-banner"></div>
        </div>
    </div>

    <script>
        // Service Worker (PWA)
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // === Config ===
        const TICK_SPEED = 0.3; 
        const MAX_LEVEL = 20;

        // === State ===
        let isRunning = false;
        let isAuto = false;
        let mode = 'PPT'; 
        let step = 0;

        let time = 720; 
        let level = 1;
        let coin = 0;
        let combo = 0;
        let freq = 60.00;

        let supply = 0, demand = 0;
        let targetSupply = 0, targetDemand = 0; 
        
        let essCap = 2000, essLevel = 1000;
        let action = 'stop', drOn = false, cutOn = false;

        // Environment
        let weather = 'sunny'; 
        let pendingEvent = null;

        // Map Nodes
        const nodes = [
            {id:'seoul', name:'ìˆ˜ë„ê¶Œ', x:0.35, y:0.25, color:'#ef5350'},
            {id:'gangwon', name:'ê°•ì›', x:0.7, y:0.2, color:'#42a5f5'},
            {id:'chungcheong', name:'ì¶©ì²­', x:0.4, y:0.45, color:'#ffa726'},
            {id:'honam', name:'í˜¸ë‚¨', x:0.3, y:0.7, color:'#ab47bc'},
            {id:'yeongnam', name:'ì˜ë‚¨', x:0.75, y:0.65, color:'#26c6da'},
            {id:'jeju', name:'ì œì£¼', x:0.3, y:0.92, color:'#66bb6a'}
        ];
        let objects = []; 

        // === System ===
        function resize() {
            if(!canvas) return;
            canvas.width = document.getElementById('map-area').clientWidth;
            canvas.height = document.getElementById('map-area').clientHeight;
        }
        window.addEventListener('resize', resize);

        function nextSlide(n) {
            document.querySelectorAll('.slide-card').forEach(s => s.classList.remove('active'));
            document.getElementById('slide-'+n).classList.add('active');
        }

        function startGame() {
            document.getElementById('intro-overlay').style.display = 'none';
            resize();
            isRunning = true;
            
            spawn('solar', 'honam', 2);
            spawn('wind', 'jeju', 1);
            spawn('apt', 'seoul', 3);

            startTutorial();
            gameLoop();
        }

        function spawn(type, rid, count=1) {
            let n = nodes.find(x=>x.id===rid);
            if(!n) return;
            for(let i=0; i<count; i++) {
                let ox = (Math.random()-0.5) * 0.15;
                let oy = (Math.random()-0.5) * 0.15;
                objects.push({type:type, x:n.x+ox, y:n.y+oy, phase:Math.random()*10});
            }
        }

        // === Tutorial ===
        function startTutorial() {
            mode = 'TUTORIAL';
            document.getElementById('btn-auto').style.pointerEvents = 'none';
            document.getElementById('btn-auto').style.opacity = '0.5';
            setTutorialStep(1);
        }

        function setTutorialStep(s) {
            step = s;
            const guide = document.getElementById('guide-overlay');
            guide.style.display = 'block';
            
            document.querySelectorAll('.ctrl-btn').forEach(b => {
                b.style.pointerEvents = 'none'; b.style.opacity = '0.2';
            });

            if(s === 1) {
                guide.innerHTML = "ğŸš¨ [ìƒí™© 1] ì „ë ¥ ë¶€ì¡±! <b>[ESS ë°©ì „]</b> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”!";
                let btn = document.getElementById('btn-discharge');
                btn.style.pointerEvents = 'auto'; btn.style.opacity = '1';
                setAIText("ìˆ˜ìš”ê°€ ê³µê¸‰ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤. ESS ì „ë ¥ì„ ê³µê¸‰í•´ì•¼ í•©ë‹ˆë‹¤.", "alert");
                targetDemand = 4000; targetSupply = 2000; 
            } 
            else if(s === 2) {
                guide.innerHTML = "ğŸš¨ [ìƒí™© 2] ì „ë ¥ ê³¼ì‰! <b>[ì¶œë ¥ì œì–´]</b>ë¥¼ ëˆ„ë¥´ì„¸ìš”!";
                let btn = document.getElementById('btn-cut');
                btn.style.pointerEvents = 'auto'; btn.style.opacity = '1';
                setAIText("ë°œì „ëŸ‰ì´ ë„ˆë¬´ ë§ì•„ ì£¼íŒŒìˆ˜ê°€ ìƒìŠ¹í•©ë‹ˆë‹¤. ë°œì „ì„ ì œí•œí•˜ì„¸ìš”.", "alert");
                targetDemand = 2000; targetSupply = 4000; 
                action = 'stop'; updateBtns();
            }
            else if(s === 3) {
                guide.innerHTML = "ğŸ‰ íŠœí† ë¦¬ì–¼ ì™„ë£Œ! ì‹¤ì „ ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.";
                setTimeout(endTutorial, 3000);
            }
        }

        function checkTutorialGoal() {
            if(mode !== 'TUTORIAL') return;
            if(step === 1 && (action === 'discharge' || drOn)) {
                setAIText("ì˜í•˜ì…¨ìŠµë‹ˆë‹¤! ESSê°€ ì „ë ¥ì„ ê³µê¸‰í•˜ì—¬ ì£¼íŒŒìˆ˜ë¥¼ íšŒë³µí•©ë‹ˆë‹¤.", "happy");
                if(freq > 59.8) setTutorialStep(2);
            }
            else if(step === 2 && (action === 'charge' || cutOn)) {
                setAIText("ì™„ë²½í•©ë‹ˆë‹¤! ê³¼ì‰ ìƒì‚°ëœ ì „ë ¥ì„ ì°¨ë‹¨í•˜ì—¬ ì•ˆì •í™”í•©ë‹ˆë‹¤.", "happy");
                if(freq < 60.2) setTutorialStep(3);
            }
        }

        function endTutorial() {
            mode = 'REAL';
            document.getElementById('guide-overlay').style.display = 'none';
            document.getElementById('btn-auto').style.pointerEvents = 'auto';
            document.getElementById('btn-auto').style.opacity = '1';
            action='stop'; drOn=false; cutOn=false; updateBtns();
            level = 1;
            targetSupply = supply; targetDemand = demand;
            setAIText("ì‹¤ì „ ëª¨ë“œ ì‹œì‘. ì£¼íŒŒìˆ˜ 60Hz ìœ ì§€ê°€ ëª©í‘œì…ë‹ˆë‹¤.", "neutral");
        }

        // === Loop ===
        function gameLoop() {
            if(!isRunning) return;
            updatePhysics();
            if(mode === 'REAL') aiLogic();
            else checkTutorialGoal();
            draw();
            updateUI();
            requestAnimationFrame(gameLoop);
        }

        function updatePhysics() {
            time += TICK_SPEED;
            if(time >= 1440) { time=0; if(mode==='REAL') handleLevelUp(); }

            // ë‚ ì”¨ ë³€í™” (ëœë¤)
            if(mode==='REAL' && Math.random()<0.001) changeWeather();

            if(pendingEvent) {
                pendingEvent.timer--;
                if(pendingEvent.timer <= 0) {
                    if(pendingEvent.type === 'build') spawn(pendingEvent.objType, pendingEvent.region, pendingEvent.count);
                    document.getElementById('event-banner').style.display='none';
                    pendingEvent = null;
                }
            }

            if(mode === 'REAL') {
                let h = time/60;
                let curve = (h>9 && h<21) ? 1.3 : 0.7;
                let baseLoad = 2000;
                objects.forEach(o=>{ if(o.type==='apt') baseLoad+=50; if(o.type==='factory') baseLoad+=200; });
                
                // ë‚ ì”¨ì— ë”°ë¥¸ ìˆ˜ìš” ë³€í™” (í­ì—¼/í•œíŒŒ)
                if(weather === 'extreme') baseLoad *= 1.2;

                let tDem = baseLoad * curve;
                if(drOn) tDem *= 0.8;

                let baseGen = 2000 + (level*100);
                let reGen = 0;
                let sun = (h>7&&h<18)?Math.sin((h-7)/11*Math.PI):0;
                let wind = 0.5 + Math.sin(time*0.05)*0.3;
                
                // ë‚ ì”¨ ë°œì „ íš¨ìœ¨
                if(weather === 'rain') sun *= 0.2;
                if(weather === 'windy') wind *= 1.5;

                objects.forEach(o=>{
                    if(o.type==='solar') reGen += 200*sun;
                    if(o.type==='wind') reGen += 250*wind;
                });
                
                let tSup = baseGen + reGen;
                if(cutOn) tSup *= 0.7;

                // ESS & Auto
                essCap = 2000 + (level*300);
                let flow = 0;
                if(isAuto) autoControl(tSup, tDem);

                if(action==='charge') flow = -1000;
                if(action==='discharge') flow = 1000;
                
                essLevel -= flow * 0.03;
                essLevel = Math.max(0, Math.min(essLevel, essCap));
                tSup += flow;

                targetDemand = tDem;
                targetSupply = tSup;
            }
            else {
                if(step===1) { if(action==='discharge') targetSupply = 4000; else targetSupply = 2000; }
                if(step===2) { if(cutOn) targetSupply = 2000; else targetSupply = 4000; }
            }

            demand += (targetDemand - demand) * 0.1;
            supply += (targetSupply - supply) * 0.1;

            let diff = supply - demand;
            freq += diff * 0.00005;
            freq += (60 - freq) * 0.05;

            // Coin & Combo
            if(mode==='REAL') {
                if(freq >= 59.95 && freq <= 60.05) {
                    combo++;
                    if(combo > 100) coin += 1; // ì±„êµ´
                } else {
                    combo = 0;
                }
            }
        }

        function handleLevelUp() {
            if(level<MAX_LEVEL) {
                level++;
                let t = ['solar','wind','apt','factory'][Math.floor(Math.random()*4)];
                let r = ['honam','gangwon','seoul','yeongnam'][Math.floor(Math.random()*4)];
                
                showBanner(`ğŸ“¢ [ì¦ì„¤ ì˜ˆë³´] ì ì‹œ í›„ ${r}ì§€ì—­ ${t} ìë™ ê±´ì„¤!`);
                pendingEvent = { type:'build', objType:t, region:r, count:2, timer:300 };
            }
        }

        function changeWeather() {
            let r = Math.random();
            let wIcon = document.getElementById('weather-icon');
            if(r < 0.2) { weather = 'rain'; showBanner("ğŸŒ§ï¸ [ë‚ ì”¨] ì „êµ­ì— ë¹„! íƒœì–‘ê´‘ íš¨ìœ¨ ê¸‰ê°!"); wIcon.innerText="ğŸŒ§ï¸"; }
            else if(r < 0.4) { weather = 'windy'; showBanner("ğŸŒªï¸ [ë‚ ì”¨] ê°•í’ ì£¼ì˜ë³´! í’ë ¥ ë°œì „ëŸ‰ ì¦ê°€!"); wIcon.innerText="ğŸŒªï¸"; }
            else { weather = 'sunny'; wIcon.innerText="â˜€ï¸"; }
        }

        function autoControl(g, l) {
            if(g > l + 150) {
                if(essLevel < essCap) { action='charge'; cutOn=false; setAIText("ì „ë ¥ì´ ë‚¨ìŠµë‹ˆë‹¤. ë‚­ë¹„ë˜ì§€ ì•Šê²Œ ì¶©ì „í•©ë‹ˆë‹¤.", "happy"); }
                else { action='stop'; cutOn=true; setAIText("ESSê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤. ì¶œë ¥ì œì–´ë¡œ ë°œì „ëŸ‰ì„ ì¤„ì…ë‹ˆë‹¤.", "worry"); }
            } else if(g < l - 100) {
                if(essLevel > 0) { action='discharge'; drOn=false; setAIText("ì „ë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì €ì¥ëœ ì „ê¸°ë¥¼ ë°©ì¶œí•©ë‹ˆë‹¤.", "alert"); }
                else { action='stop'; drOn=true; setAIText("ë¹„ìƒ! ESS ê³ ê°ˆ. DRë¡œ ê³µì¥ì„ ë©ˆì¶¥ë‹ˆë‹¤.", "alert"); }
            } else {
                action='stop'; cutOn=false; drOn=false; setAIText("ìˆ˜ê¸‰ì´ ì•ˆì •ì ì…ë‹ˆë‹¤. ì±„êµ´ ëª¨ë“œ ê°€ë™.", "happy");
            }
            updateBtns();
        }

        function aiLogic() {
            if(isAuto) return; 
            if(supply > demand + 150) setAIText("ì „ë ¥ ê³¼ì‰! [ì¶©ì „] ë˜ëŠ” [ì¶œë ¥ì œì–´] í•˜ì„¸ìš”.", "worry");
            else if(supply < demand - 100) setAIText("ì „ë ¥ ë¶€ì¡±! [ë°©ì „] ë˜ëŠ” [DR] í•˜ì„¸ìš”.", "alert");
            else setAIText("ì•ˆì •ì ì…ë‹ˆë‹¤. ì£¼íŒŒìˆ˜ 60Hz ìœ ì§€ ì¤‘.", "neutral");
        }

        function setAIText(msg, mood) {
            const box = document.getElementById('ai-box');
            const txt = document.getElementById('ai-text');
            const face = document.querySelector('.ai-face');
            txt.innerText = msg;
            if(mood==='alert') { box.style.borderColor='var(--danger)'; face.innerText='ğŸš¨'; }
            else if(mood==='worry') { box.style.borderColor='var(--accent)'; face.innerText='ğŸ˜®'; }
            else if(mood==='happy') { box.style.borderColor='var(--success)'; face.innerText='ğŸ¤–'; }
            else { box.style.borderColor='#444'; face.innerText='ğŸ¤–'; }
        }

        // === Control ===
        function toggleAuto() {
            isAuto = !isAuto;
            let btn = document.getElementById('btn-auto');
            btn.classList.toggle('on', isAuto);
            if(!isAuto) { action='stop'; drOn=false; cutOn=false; updateBtns(); }
        }

        function manual(act) {
            if(isAuto) return;
            action = (action === act) ? 'stop' : act; updateBtns();
        }
        function toggleDR() { if(!isAuto) { drOn=!drOn; updateBtns(); } }
        function toggleCut() { if(!isAuto) { cutOn=!cutOn; updateBtns(); } }

        function updateBtns() {
            document.querySelectorAll('.ctrl-btn').forEach(b=>b.classList.remove('active'));
            if(action==='charge') document.getElementById('btn-charge').classList.add('active');
            if(action==='discharge') document.getElementById('btn-discharge').classList.add('active');
            if(drOn) document.getElementById('btn-dr').classList.add('active');
            if(cutOn) document.getElementById('btn-cut').classList.add('active');
        }

        function showBanner(msg) {
            let b = document.getElementById('forecast-banner');
            b.innerText = msg; b.style.display = 'block';
            setTimeout(()=>b.style.display='none', 4000);
        }

        // === Draw ===
        function draw() {
            let w=canvas.width; let h=canvas.height;
            ctx.clearRect(0,0,w,h);

            // Line
            ctx.strokeStyle='rgba(255,255,255,0.1)'; ctx.lineWidth=2; ctx.beginPath();
            let c = getNodePos('chungcheong');
            nodes.forEach(n=>{ if(n.id!=='chungcheong'&&n.id!=='jeju') { let p=getNodePos(n.id); ctx.moveTo(c.x, c.y); ctx.lineTo(p.x, p.y); }});
            let p1=getNodePos('honam'), p2=getNodePos('jeju'); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y);
            ctx.stroke();

            // Node
            nodes.forEach(n=>{
                let p=getNodePos(n.id);
                ctx.beginPath(); ctx.arc(p.x, p.y, 50, 0, Math.PI*2);
                ctx.fillStyle=n.color; ctx.globalAlpha=0.2; ctx.fill();
                ctx.strokeStyle=n.color; ctx.globalAlpha=1; ctx.lineWidth=2; ctx.stroke();
                ctx.fillStyle='#fff'; ctx.font='bold 16px Noto Sans KR'; ctx.textAlign='center';
                ctx.fillText(n.name, p.x, p.y-10);
            });

            // Icon
            objects.forEach(o=>{
                let px=o.x*w; let py=o.y*h;
                let icon = o.type==='solar'?'â˜€ï¸':(o.type==='wind'?'ğŸŒ€':(o.type==='apt'?'ğŸ¢':'ğŸ­'));
                let float = Math.sin(Date.now()*0.003 + o.phase)*3;
                ctx.font='24px Arial'; ctx.fillText(icon, px, py+float);
            });
        }

        function getNodePos(id) {
            let w=canvas.width; let h=canvas.height;
            let n=nodes.find(x=>x.id===id);
            return {x:n.x*w, y:n.y*h};
        }

        function updateUI() {
            let hh=Math.floor(time/60).toString().padStart(2,'0');
            let mm=Math.floor(time%60).toString().padStart(2,'0');
            document.getElementById('ui-time').innerText = `${hh}:${mm}`;
            document.getElementById('ui-level').innerText = level;
            document.getElementById('ui-coin').innerText = coin.toLocaleString();

            let fEl = document.getElementById('ui-freq');
            fEl.innerText = freq.toFixed(2);
            fEl.style.color = (freq<59.8||freq>60.2) ? 'var(--danger)' : 'var(--primary)';

            document.getElementById('val-sup').innerText = Math.floor(supply);
            document.getElementById('val-dem').innerText = Math.floor(demand);
            
            let soc = Math.floor(essLevel/essCap*100);
            document.getElementById('val-soc').innerText = soc + "%";
            document.getElementById('bar-soc').style.width = soc + "%";

            document.getElementById('cnt-solar').innerText = objects.filter(o=>o.type==='solar').length;
            document.getElementById('cnt-wind').innerText = objects.filter(o=>o.type==='wind').length;
            document.getElementById('cnt-apt').innerText = objects.filter(o=>o.type==='apt').length;
            document.getElementById('cnt-fac').innerText = objects.filter(o=>o.type==='factory').length;

            // Combo
            let cBox = document.getElementById('ui-combo');
            if(cBox) cBox.style.display = (combo > 50) ? 'block' : 'none';
        }
    </script>
</body>
</html>
